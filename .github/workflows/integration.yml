name: Integration Tests 

on:
  # Run after CI or Release workflow completes
  # - CI on main: catches issues before release (uses 'latest' image)
  # - Release on tags: tests the actual released image (uses tag like 'v0.6.0')
  workflow_run:
    workflows: ["CI", "Release"]
    types:
      - completed
  # Manual trigger for testing specific protocols/tests
  workflow_dispatch:
    inputs:
      protocol:
        description: 'Protocol to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - nfs
          - nvmeof
      test:
        description: 'Specific test to run (leave empty for all tests of selected protocol)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - basic
          - snapshot
          - detached-snapshot
          - concurrent
          - persistence
          - statefulset
          - volume-expansion
          - zfsprops
          - name-templating
          - clone-volume
          - delete-strategy-retain
          - block-mode
          - snapshot-stress
          - dual-mount
          - connection-resilience
          - pod-restart
          - access-modes
          - snapshot-restore
          - volume-stress
          - error-handling

# Restrict permissions to minimum required
permissions:
  contents: read

# Ensure only one integration test runs at a time on the new runner
concurrency:
  group: integration-tests
  cancel-in-progress: false

jobs:
  # ==========================================
  # Setup Phase
  # ==========================================
  compute-tag:
    name: Compute Image Tag
    runs-on: new
    # Skip if:
    # - triggered by workflow_run and the workflow failed
    # - triggered by CI workflow but not on main branch (only run integration tests for main)
    if: |
      github.event_name != 'workflow_run' || 
      (github.event.workflow_run.conclusion == 'success' && 
       (github.event.workflow_run.name == 'Release' || github.event.workflow_run.head_branch == 'main'))
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Compute image tag from ref
        id: tag
        run: |
          # For workflow_run events, get ref from the triggering workflow
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF_NAME="${{ github.event.workflow_run.head_branch }}"
            # Check if it was triggered by a tag (Release workflow)
            if [ "${{ github.event.workflow_run.event }}" = "push" ] && [[ "${{ github.event.workflow_run.head_branch }}" == v* ]]; then
              REF_TYPE="tag"
            else
              REF_TYPE="branch"
            fi
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            echo "Triggered by workflow: $WORKFLOW_NAME"
          else
            # For manual dispatch or other events
            REF_NAME="${{ github.ref_name }}"
            REF_TYPE="${{ github.ref_type }}"
          fi
          
          echo "REF_NAME: $REF_NAME, REF_TYPE: $REF_TYPE"
          
          if [ "$REF_TYPE" = "tag" ]; then
            # For tags like v0.5.0, strip the 'v' prefix to match Docker image tags
            # Release workflow uses semver pattern which produces tags like 0.5.0 (without v)
            TAG="${REF_NAME#v}"
            echo "Using image tag: $TAG (from tag: $REF_NAME)"
          elif [ "$REF_NAME" = "main" ]; then
            TAG="latest"
            echo "Using image tag: $TAG (from branch: $REF_NAME)"
          else
            TAG=$(echo "$REF_NAME" | sed 's/\//-/g')
            echo "Using image tag: $TAG (from branch: $REF_NAME)"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  # ==========================================
  # Ginkgo E2E Tests (Experimental)
  # ==========================================
  ginkgo-e2e-nfs:
    name: "Ginkgo E2E: NFS"
    runs-on: new
    timeout-minutes: 30
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Ginkgo NFS E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== Running Ginkgo NFS E2E Tests ==="
          # Run only NFS-specific tests from the nfs/ directory
          ginkgo -v --progress --timeout=25m ./tests/e2e/nfs/...
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ginkgo-e2e-nfs-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  ginkgo-e2e-nvmeof:
    name: "Ginkgo E2E: NVMe-oF"
    runs-on: new
    timeout-minutes: 45
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Ginkgo NVMe-oF E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== Running Ginkgo NVMe-oF E2E Tests ==="
          # Run only NVMe-oF-specific tests from the nvmeof/ directory
          ginkgo -v --progress --timeout=40m ./tests/e2e/nvmeof/...
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ginkgo-e2e-nvmeof-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  ginkgo-e2e-shared:
    name: "Ginkgo E2E: Shared"
    runs-on: new
    timeout-minutes: 30
    needs: compute-tag
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Ginkgo Shared E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== Running Ginkgo Shared E2E Tests ==="
          # Run shared tests from the root e2e/ directory (not nfs/ or nvmeof/)
          # These tests use "both" protocol setup
          ginkgo -v --progress --timeout=25m ./tests/e2e/
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ginkgo-e2e-shared-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  # ==========================================
  # NFS Tests
  # ==========================================
  nfs-basic:
    name: "NFS: Basic"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'basic')
    steps:
      - uses: actions/checkout@v6
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-nfs.sh

  # ==========================================
  # NVMe-oF Tests
  # ==========================================
  nvmeof-delete-strategy-retain:
    name: "NVMe-oF: Delete Strategy Retain"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'delete-strategy-retain')
    steps:
      - uses: actions/checkout@v6
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-delete-strategy-retain-nvmeof.sh
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: nvmeof-delete-strategy-retain-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  # ==========================================
  # Shared Tests
  # ==========================================
  shared-pod-restart:
    name: "Shared: Pod Restart"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      (github.event.inputs.test == '' || github.event.inputs.test == 'pod-restart')
    steps:
      - uses: actions/checkout@v6
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-pod-restart.sh

  shared-access-modes:
    name: "Shared: Access Modes"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      (github.event.inputs.test == '' || github.event.inputs.test == 'access-modes')
    steps:
      - uses: actions/checkout@v6
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-access-modes.sh

  shared-snapshot-restore:
    name: "Shared: Snapshot Restore"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      (github.event.inputs.test == '' || github.event.inputs.test == 'snapshot-restore')
    steps:
      - uses: actions/checkout@v6
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-snapshot-restore.sh
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: snapshot-restore-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  shared-volume-stress:
    name: "Shared: Volume Stress"
    runs-on: new
    timeout-minutes: 30
    needs: compute-tag
    if: |
      (github.event.inputs.test == '' || github.event.inputs.test == 'volume-stress')
    steps:
      - uses: actions/checkout@v6
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          echo "=== Starting Volume Stress Test ==="
          date
          stdbuf -o0 ./tests/integration/test-volume-stress.sh
          echo "=== Volume Stress Test Completed ==="
          date

  shared-snapshot-stress:
    name: "Shared: Snapshot Stress"
    runs-on: new
    timeout-minutes: 30
    needs: compute-tag
    if: |
      (github.event.inputs.test == '' || github.event.inputs.test == 'snapshot-stress')
    steps:
      - uses: actions/checkout@v6
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-snapshot-stress.sh
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: snapshot-stress-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  # ==========================================
  # Summary
  # ==========================================
  test-summary:
    name: "Test Summary"
    runs-on: new
    timeout-minutes: 5
    needs: [nfs-basic, nvmeof-delete-strategy-retain, shared-pod-restart, shared-access-modes, shared-snapshot-restore, shared-volume-stress, shared-snapshot-stress, ginkgo-e2e-nfs, ginkgo-e2e-nvmeof, ginkgo-e2e-shared]
    if: always()
    steps:
      - name: Generate Test Summary
        uses: actions/github-script@v8
        with:
          script: |
            const results = {
              // NFS Tests
              'Basic': '${{ needs.nfs-basic.result }}',
            };
            
            const nvmeofResults = {
              'Delete Strategy Retain': '${{ needs.nvmeof-delete-strategy-retain.result }}',
            };
            
            const sharedResults = {
              'Pod Restart': '${{ needs.shared-pod-restart.result }}',
              'Access Modes': '${{ needs.shared-access-modes.result }}',
              'Snapshot Restore': '${{ needs.shared-snapshot-restore.result }}',
              'Volume Stress': '${{ needs.shared-volume-stress.result }}',
              'Snapshot Stress': '${{ needs.shared-snapshot-stress.result }}',
            };
            
            const ginkgoResults = {
              'NFS E2E': '${{ needs.ginkgo-e2e-nfs.result }}',
              'NVMe-oF E2E': '${{ needs.ginkgo-e2e-nvmeof.result }}',
              'Shared E2E': '${{ needs.ginkgo-e2e-shared.result }}',
            };
            
            const getIcon = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                case 'cancelled': return 'ðŸš«';
                default: return 'âšª';
              }
            };
            
            const countResults = (obj) => {
              let passed = 0, failed = 0, skipped = 0;
              for (const result of Object.values(obj)) {
                if (result === 'success') passed++;
                else if (result === 'failure') failed++;
                else if (result === 'skipped') skipped++;
              }
              return { passed, failed, skipped };
            };
            
            const nfsCounts = countResults(results);
            const nvmeofCounts = countResults(nvmeofResults);
            const sharedCounts = countResults(sharedResults);
            const ginkgoCounts = countResults(ginkgoResults);
            
            const totalPassed = nfsCounts.passed + nvmeofCounts.passed + sharedCounts.passed + ginkgoCounts.passed;
            const totalFailed = nfsCounts.failed + nvmeofCounts.failed + sharedCounts.failed + ginkgoCounts.failed;
            const totalSkipped = nfsCounts.skipped + nvmeofCounts.skipped + sharedCounts.skipped + ginkgoCounts.skipped;
            const total = Object.keys(results).length + Object.keys(nvmeofResults).length + Object.keys(sharedResults).length + Object.keys(ginkgoResults).length;
            
            let summary = `# Integration Test Results\n\n`;
            
            // Overall status banner
            if (totalFailed > 0) {
              summary += `> ### ${totalFailed} test(s) failed\n\n`;
            } else if (totalPassed === total) {
              summary += `> ### All ${total} tests passed!\n\n`;
            } else {
              summary += `> ### ${totalPassed}/${totalPassed + totalFailed} tests passed (${totalSkipped} skipped)\n\n`;
            }
            
            // Quick stats
            summary += `| Passed | Failed | Skipped | Total |\n`;
            summary += `|:------:|:------:|:-------:|:-----:|\n`;
            summary += `| ${totalPassed} | ${totalFailed} | ${totalSkipped} | ${total} |\n\n`;
            
            // Ginkgo E2E Tests
            summary += `## Ginkgo E2E Tests\n\n`;
            summary += `| Test Suite | Status |\n`;
            summary += `|------------|:------:|\n`;
            for (const [test, result] of Object.entries(ginkgoResults)) {
              summary += `| ${test} | ${getIcon(result)} |\n`;
            }
            
            // NFS Bash Tests
            summary += `\n## NFS Bash Tests\n\n`;
            summary += `| Test | Status |\n`;
            summary += `|------|:------:|\n`;
            for (const [test, result] of Object.entries(results)) {
              summary += `| ${test} | ${getIcon(result)} |\n`;
            }
            
            // NVMe-oF Bash Tests
            summary += `\n## NVMe-oF Bash Tests\n\n`;
            summary += `| Test | Status |\n`;
            summary += `|------|:------:|\n`;
            for (const [test, result] of Object.entries(nvmeofResults)) {
              summary += `| ${test} | ${getIcon(result)} |\n`;
            }
            
            // Shared Bash Tests
            summary += `\n## Shared Bash Tests\n\n`;
            summary += `| Test | Status |\n`;
            summary += `|------|:------:|\n`;
            for (const [test, result] of Object.entries(sharedResults)) {
              summary += `| ${test} | ${getIcon(result)} |\n`;
            }
            
            // Write to job summary
            await core.summary.addRaw(summary).write();
            
            // Fail if any test failed
            if (totalFailed > 0) {
              core.setFailed(`${totalFailed} test(s) failed`);
            }
