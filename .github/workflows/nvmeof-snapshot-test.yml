name: NVMe-oF Snapshot Test

on:
  workflow_dispatch:

jobs:
  integration-nvmeof:
    name: NVMe-oF Integration Tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run NVMe-oF Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-nvmeof.sh

  integration-snapshot-nvmeof:
    name: NVMe-oF Snapshot Integration Tests
    runs-on: self-hosted
    needs: integration-nvmeof
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - uses: ./.github/actions/setup-snapshots
      - name: Run NVMe-oF Snapshot Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-snapshot-nvmeof.sh

  cleanup:
    name: Cleanup TrueNAS Artifacts
    runs-on: self-hosted
    needs: [integration-nvmeof, integration-snapshot-nvmeof]
    if: always()
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'
          cache: false

      - name: Run TrueNAS cleanup
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Running TrueNAS artifact cleanup ==="
          ./scripts/cleanup-truenas-artifacts.sh
          echo "=== Cleanup complete ==="
