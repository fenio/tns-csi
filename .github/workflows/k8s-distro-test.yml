name: Kubernetes Distribution Testing

on:
  push:
    branches: [ k8s-test ]
  pull_request:
    branches: [ k8s-test, main ]
  workflow_dispatch:

jobs:
  test-kubesolo:
    name: Test KubeSolo Setup
    runs-on: [self-hosted, Linux]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Clean up existing Kubernetes clusters
        run: |
          echo "=== Cleaning up existing clusters ==="
          # Stop k0s if running
          if sudo systemctl is-active --quiet k0scontroller; then
            echo "Stopping k0s..."
            sudo systemctl stop k0scontroller
            sudo systemctl disable k0scontroller
          fi
          
          # Kill any remaining k8s processes
          sudo pkill -9 k0s || true
          sudo pkill -9 k3s || true
          sudo pkill -9 kubelet || true
          sudo pkill -9 kube-apiserver || true
          
          # Clean up directories
          sudo rm -rf /var/lib/k0s
          sudo rm -rf /var/lib/k3s
          sudo rm -rf /run/k0s
          
          # Wait for port 6443 to be released
          echo "Waiting for port 6443 to be released..."
          for i in {1..30}; do
            if ! ss -tlnp 2>/dev/null | grep -q 6443; then
              echo "Port 6443 is now free"
              break
            fi
            echo "Port 6443 still in use, waiting... ($i/30)"
            sleep 1
          done
          
          echo "=== System Info ==="
          uname -a
          echo ""
          echo "=== Port 6443 status ==="
          ss -tlnp 2>/dev/null | grep 6443 || echo "Port 6443 not in use"
          echo ""
          echo "=== Existing k8s processes ==="
          ps aux | grep -E "kube|k3s|k0s|minikube" | grep -v grep || echo "No k8s processes found"

      - name: Setup KubeSolo
        uses: fenio/setup-kubesolo@v3
        with:
          timeout: 300

      - name: Verify KubeSolo cluster
        env:
          KUBECONFIG: /var/lib/kubesolo/pki/admin/admin.kubeconfig
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A
          
          echo "Checking Kubernetes version..."
          kubectl version

      - name: Test basic workload
        env:
          KUBECONFIG: /var/lib/kubesolo/pki/admin/admin.kubeconfig
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  test-k3s:
    name: Test K3s Setup
    runs-on: [self-hosted, Linux]
    needs: [test-kubesolo]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Clean up previous cluster
        run: |
          echo "Cleaning up KubeSolo..."
          sudo systemctl stop kubesolo || true
          sudo pkill -9 kubesolo || true
          sudo rm -rf /var/lib/kubesolo
          sleep 5

      - name: Setup K3s
        uses: fenio/setup-k3s@v1
        with:
          timeout: 300

      - name: Verify K3s cluster
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A
          
          echo "Checking Kubernetes version..."
          kubectl version

      - name: Test basic workload
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  test-k0s:
    name: Test k0s Setup
    runs-on: [self-hosted, Linux]
    needs: [test-k3s]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Clean up previous cluster
        run: |
          echo "Cleaning up K3s..."
          sudo systemctl stop k3s || true
          sudo pkill -9 k3s || true
          sudo rm -rf /var/lib/k3s
          sleep 5

      - name: Setup k0s
        uses: fenio/setup-k0s@v1
        with:
          timeout: 300

      - name: Verify k0s cluster
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A
          
          echo "Checking Kubernetes version..."
          kubectl version

      - name: Test basic workload
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  test-minikube:
    name: Test Minikube Setup
    runs-on: [self-hosted, Linux]
    needs: [test-k0s]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Minikube
        uses: fenio/setup-minikube@v1
        with:
          driver: none
          timeout: 300

      - name: Verify Minikube cluster
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A
          
          echo "Checking Kubernetes version..."
          kubectl version

      - name: Test basic workload
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  compare-distros:
    name: Compare Distributions
    runs-on: [self-hosted, Linux]
    needs: [test-kubesolo, test-k3s, test-k0s, test-minikube]
    if: always()
    steps:
      - name: Report results
        run: |
          echo "# Kubernetes Distribution Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- KubeSolo: ${{ needs.test-kubesolo.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- K3s: ${{ needs.test-k3s.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- k0s: ${{ needs.test-k0s.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Minikube: ${{ needs.test-minikube.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-kubesolo.result }}" == "success" ] && [ "${{ needs.test-k3s.result }}" == "success" ] && [ "${{ needs.test-k0s.result }}" == "success" ] && [ "${{ needs.test-minikube.result }}" == "success" ]; then
            echo "✅ All distributions tested successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Some distributions failed testing." >> $GITHUB_STEP_SUMMARY
          fi
