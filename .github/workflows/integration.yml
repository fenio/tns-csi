name: Integration Tests 

on:
  # Run after CI or Release workflow completes
  # - CI on main: catches issues before release (uses 'latest' image)
  # - Release on tags: tests the actual released image (uses tag like 'v0.6.0')
  workflow_run:
    workflows: ["CI", "Release"]
    types:
      - completed
  # Manual trigger for testing specific protocols/tests
  workflow_dispatch:
    inputs:
      protocol:
        description: 'Protocol to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - nfs
          - nvmeof
      test:
        description: 'Specific test to run (leave empty for all tests of selected protocol)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - basic
          - snapshot
          - detached-snapshot
          - concurrent
          - persistence
          - statefulset
          - volume-expansion
          - zfsprops
          - name-templating
          - clone-volume
          - delete-strategy-retain
          - block-mode
          - snapshot-stress
          - dual-mount
          - connection-resilience
          - pod-restart
          - access-modes
          - snapshot-restore
          - volume-stress
          - error-handling

# Restrict permissions to minimum required
permissions:
  contents: read

# Ensure only one integration test runs at a time on the new runner
concurrency:
  group: integration-tests
  cancel-in-progress: false

jobs:
  # ==========================================
  # Setup Phase
  # ==========================================
  compute-tag:
    name: Compute Image Tag
    runs-on: new
    # Skip if:
    # - triggered by workflow_run and the workflow failed
    # - triggered by CI workflow but not on main branch (only run integration tests for main)
    if: |
      github.event_name != 'workflow_run' || 
      (github.event.workflow_run.conclusion == 'success' && 
       (github.event.workflow_run.name == 'Release' || github.event.workflow_run.head_branch == 'main'))
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Compute image tag from ref
        id: tag
        run: |
          # For workflow_run events, get ref from the triggering workflow
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF_NAME="${{ github.event.workflow_run.head_branch }}"
            # Check if it was triggered by a tag (Release workflow)
            if [ "${{ github.event.workflow_run.event }}" = "push" ] && [[ "${{ github.event.workflow_run.head_branch }}" == v* ]]; then
              REF_TYPE="tag"
            else
              REF_TYPE="branch"
            fi
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            echo "Triggered by workflow: $WORKFLOW_NAME"
          else
            # For manual dispatch or other events
            REF_NAME="${{ github.ref_name }}"
            REF_TYPE="${{ github.ref_type }}"
          fi
          
          echo "REF_NAME: $REF_NAME, REF_TYPE: $REF_TYPE"
          
          if [ "$REF_TYPE" = "tag" ]; then
            # For tags like v0.5.0, strip the 'v' prefix to match Docker image tags
            # Release workflow uses semver pattern which produces tags like 0.5.0 (without v)
            TAG="${REF_NAME#v}"
            echo "Using image tag: $TAG (from tag: $REF_NAME)"
          elif [ "$REF_NAME" = "main" ]; then
            TAG="latest"
            echo "Using image tag: $TAG (from branch: $REF_NAME)"
          else
            TAG=$(echo "$REF_NAME" | sed 's/\//-/g')
            echo "Using image tag: $TAG (from branch: $REF_NAME)"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  # ==========================================
  # E2E Tests
  # ==========================================
  ginkgo-e2e-nfs:
    name: "E2E: NFS"
    runs-on: new
    timeout-minutes: 30
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run NFS E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== Running NFS E2E Tests ==="
          # Run only NFS-specific tests from the nfs/ directory
          ginkgo -v --timeout=25m ./tests/e2e/nfs/...
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-nfs-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  ginkgo-e2e-nvmeof:
    name: "E2E: NVMe-oF"
    runs-on: new
    timeout-minutes: 45
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '')
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run NVMe-oF E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== Running NVMe-oF E2E Tests ==="
          # Run only NVMe-oF-specific tests from the nvmeof/ directory
          ginkgo -v --timeout=40m ./tests/e2e/nvmeof/...
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-nvmeof-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  ginkgo-e2e-shared:
    name: "E2E: Shared"
    runs-on: new
    timeout-minutes: 30
    needs: compute-tag
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - uses: ./.github/actions/setup-snapshots
      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
      - name: Run Shared E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "=== Running Shared E2E Tests ==="
          # Run shared tests from the root e2e/ directory (not nfs/ or nvmeof/)
          # These tests use "both" protocol setup
          ginkgo -v --timeout=25m ./tests/e2e/
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-shared-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  # ==========================================
  # Summary
  # ==========================================
  # Note: All integration tests have been migrated to Ginkgo E2E tests.
  # - Protocol-specific tests: tests/e2e/nfs/ and tests/e2e/nvmeof/
  # - Shared tests (both protocols): tests/e2e/snapshot_restore_test.go, tests/e2e/stress_test.go

  test-summary:
    name: "Test Summary"
    runs-on: new
    timeout-minutes: 5
    needs: [ginkgo-e2e-nfs, ginkgo-e2e-nvmeof, ginkgo-e2e-shared]
    if: always()
    steps:
      - name: Generate Test Summary
        uses: actions/github-script@v8
        with:
          script: |
            const e2eResults = {
              'NFS E2E': '${{ needs.ginkgo-e2e-nfs.result }}',
              'NVMe-oF E2E': '${{ needs.ginkgo-e2e-nvmeof.result }}',
              'Shared E2E': '${{ needs.ginkgo-e2e-shared.result }}',
            };
            
            const getIcon = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                case 'cancelled': return 'ğŸš«';
                default: return 'âšª';
              }
            };
            
            let passed = 0, failed = 0, skipped = 0;
            for (const result of Object.values(e2eResults)) {
              if (result === 'success') passed++;
              else if (result === 'failure') failed++;
              else if (result === 'skipped') skipped++;
            }
            const total = Object.keys(e2eResults).length;
            
            let summary = `# Integration Test Results\n\n`;
            
            // Overall status banner
            if (failed > 0) {
              summary += `> ### ${failed} test(s) failed\n\n`;
            } else if (passed === total) {
              summary += `> ### All ${total} tests passed!\n\n`;
            } else {
              summary += `> ### ${passed}/${passed + failed} tests passed (${skipped} skipped)\n\n`;
            }
            
            // Quick stats
            summary += `| Passed | Failed | Skipped | Total |\n`;
            summary += `|:------:|:------:|:-------:|:-----:|\n`;
            summary += `| ${passed} | ${failed} | ${skipped} | ${total} |\n\n`;
            
            // E2E Tests
            summary += `## E2E Tests\n\n`;
            summary += `| Test Suite | Status |\n`;
            summary += `|------------|:------:|\n`;
            for (const [test, result] of Object.entries(e2eResults)) {
              summary += `| ${test} | ${getIcon(result)} |\n`;
            }
            summary += `\n_Note: Shared E2E includes Snapshot Restore, Volume Stress, and Snapshot Stress tests for both NFS and NVMe-oF._\n`;
            
            // Write to job summary
            await core.summary.addRaw(summary).write();
            
            // Fail if any test failed
            if (failed > 0) {
              core.setFailed(`${failed} test(s) failed`);
            }
