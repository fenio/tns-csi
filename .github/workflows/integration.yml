name: Integration Tests

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'README.md'
      - 'AGENTS.md'
      - 'CONTRIBUTING.md'
      - 'SECURITY.md'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'README.md'
      - 'AGENTS.md'
      - 'CONTRIBUTING.md'
      - 'SECURITY.md'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  integration-nfs:
    name: NFS Integration Tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-integration-env
        with:
          protocol: nfs
      - name: Run NFS Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-nfs.sh

  integration-nvmeof:
    name: NVMe-oF Integration Tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-integration-env
        with:
          protocol: nvmeof
      - name: Run NVMe-oF Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-nvmeof.sh

  integration-snapshot-nfs:
    name: NFS Snapshot Integration Tests
    runs-on: self-hosted
    needs: integration-nfs
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-integration-env
        with:
          protocol: nfs
      - name: Install Snapshot CRDs
        run: |
          echo "=== Installing Volume Snapshot CRDs ==="
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
          echo "Waiting for CRDs to be established..."
          kubectl wait --for condition=established --timeout=60s crd/volumesnapshotclasses.snapshot.storage.k8s.io
          kubectl wait --for condition=established --timeout=60s crd/volumesnapshotcontents.snapshot.storage.k8s.io
          kubectl wait --for condition=established --timeout=60s crd/volumesnapshots.snapshot.storage.k8s.io
      - name: Install Snapshot Controller
        run: |
          echo "=== Installing Snapshot Controller ==="
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml
          echo "Waiting for snapshot-controller to be ready..."
          kubectl wait --for=condition=available --timeout=60s deployment/snapshot-controller -n kube-system || true
          kubectl get pods -n kube-system | grep snapshot-controller
      - name: Run NFS Snapshot Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-snapshot-nfs.sh

  integration-snapshot-nvmeof:
    name: NVMe-oF Snapshot Integration Tests
    runs-on: self-hosted
    needs: integration-nvmeof
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-integration-env
        with:
          protocol: nvmeof
      - name: Install Snapshot CRDs
        run: |
          echo "=== Installing Volume Snapshot CRDs ==="
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
          echo "Waiting for CRDs to be established..."
          kubectl wait --for condition=established --timeout=60s crd/volumesnapshotclasses.snapshot.storage.k8s.io
          kubectl wait --for condition=established --timeout=60s crd/volumesnapshotcontents.snapshot.storage.k8s.io
          kubectl wait --for condition=established --timeout=60s crd/volumesnapshots.snapshot.storage.k8s.io
      - name: Install Snapshot Controller
        run: |
          echo "=== Installing Snapshot Controller ==="
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml
          echo "Waiting for snapshot-controller to be ready..."
          kubectl wait --for=condition=available --timeout=60s deployment/snapshot-controller -n kube-system || true
          kubectl get pods -n kube-system | grep snapshot-controller
      - name: Run NVMe-oF Snapshot Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-snapshot-nvmeof.sh

  integration-concurrent-nfs:
    name: NFS Concurrent Volume Tests
    runs-on: self-hosted
    needs: integration-nfs
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-integration-env
        with:
          protocol: nfs
      - name: Run NFS Concurrent Volume Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-concurrent-nfs.sh

  integration-concurrent-nvmeof:
    name: NVMe-oF Concurrent Volume Tests
    runs-on: self-hosted
    needs: integration-nvmeof
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nvme-cli
          sudo modprobe nvme-tcp || echo "nvme-tcp module already loaded"
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Destroy existing k3s cluster
        run: |
          echo "=== Destroying existing k3s cluster for clean state ==="
          if command -v k3s-uninstall.sh &> /dev/null; then
            sudo k3s-uninstall.sh || true
          fi
          sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s ~/.kube/config || true
          echo "k3s cluster destroyed"
      
      - name: Install k3s (fresh cluster)
        run: |
          echo "=== Installing fresh k3s cluster ==="
          curl -sfL https://get.k3s.io | sh -s - \
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --disable servicelb
          
          echo "Waiting for k3s service to start..."
          sleep 15
          
          echo "Waiting for cluster nodes to register and become ready..."
          retries=0
          while [[ $retries -lt 24 ]]; do
            if sudo k3s kubectl get nodes &>/dev/null; then
              echo "Node registered, checking Ready condition..."
              if sudo k3s kubectl wait --for=condition=Ready node --all --timeout=10s 2>/dev/null; then
                echo "Fresh k3s cluster ready"
                sudo k3s kubectl get nodes
                exit 0
              fi
            fi
            echo "Waiting for cluster... (attempt $((retries+1))/24)"
            sleep 5
            retries=$((retries + 1))
          done
          echo "ERROR: Cluster failed to become ready within 2 minutes"
          sudo systemctl status k3s || true
          exit 1
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Run NVMe-oF Concurrent Volume Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-concurrent-nvmeof.sh

  integration-persistence-nfs:
    name: NFS Data Persistence Tests
    runs-on: self-hosted
    needs: integration-concurrent-nfs
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nfs-common
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Destroy existing k3s cluster
        run: |
          echo "=== Destroying existing k3s cluster for clean state ==="
          if command -v k3s-uninstall.sh &> /dev/null; then
            sudo k3s-uninstall.sh || true
          fi
          sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s ~/.kube/config || true
      
      - name: Install k3s (fresh cluster)
        run: |
          echo "=== Installing fresh k3s cluster ==="
          curl -sfL https://get.k3s.io | sh -s - \
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --disable servicelb
          sleep 15
          retries=0
          while [[ $retries -lt 24 ]]; do
            if sudo k3s kubectl get nodes &>/dev/null; then
              if sudo k3s kubectl wait --for=condition=Ready node --all --timeout=10s 2>/dev/null; then
                echo "Fresh k3s cluster ready"
                exit 0
              fi
            fi
            sleep 5
            retries=$((retries + 1))
          done
          exit 1
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Run NFS Data Persistence Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-persistence-nfs.sh

  integration-persistence-nvmeof:
    name: NVMe-oF Data Persistence Tests
    runs-on: self-hosted
    needs: integration-concurrent-nvmeof
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nvme-cli
          sudo modprobe nvme-tcp || echo "nvme-tcp module already loaded"
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Destroy existing k3s cluster
        run: |
          echo "=== Destroying existing k3s cluster for clean state ==="
          if command -v k3s-uninstall.sh &> /dev/null; then
            sudo k3s-uninstall.sh || true
          fi
          sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s ~/.kube/config || true
      
      - name: Install k3s (fresh cluster)
        run: |
          echo "=== Installing fresh k3s cluster ==="
          curl -sfL https://get.k3s.io | sh -s - \
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --disable servicelb
          sleep 15
          retries=0
          while [[ $retries -lt 24 ]]; do
            if sudo k3s kubectl get nodes &>/dev/null; then
              if sudo k3s kubectl wait --for=condition=Ready node --all --timeout=10s 2>/dev/null; then
                echo "Fresh k3s cluster ready"
                exit 0
              fi
            fi
            sleep 5
            retries=$((retries + 1))
          done
          exit 1
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Run NVMe-oF Data Persistence Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-persistence-nvmeof.sh

  integration-statefulset-nfs:
    name: NFS StatefulSet Tests
    runs-on: self-hosted
    needs: integration-persistence-nfs
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nfs-common
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Destroy existing k3s cluster
        run: |
          echo "=== Destroying existing k3s cluster for clean state ==="
          if command -v k3s-uninstall.sh &> /dev/null; then
            sudo k3s-uninstall.sh || true
          fi
          sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s ~/.kube/config || true
      
      - name: Install k3s (fresh cluster)
        run: |
          echo "=== Installing fresh k3s cluster ==="
          curl -sfL https://get.k3s.io | sh -s - \
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --disable servicelb
          sleep 15
          retries=0
          while [[ $retries -lt 24 ]]; do
            if sudo k3s kubectl get nodes &>/dev/null; then
              if sudo k3s kubectl wait --for=condition=Ready node --all --timeout=10s 2>/dev/null; then
                echo "Fresh k3s cluster ready"
                exit 0
              fi
            fi
            sleep 5
            retries=$((retries + 1))
          done
          exit 1
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Run NFS StatefulSet Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-statefulset-nfs.sh

  integration-statefulset-nvmeof:
    name: NVMe-oF StatefulSet Tests
    runs-on: self-hosted
    needs: integration-persistence-nvmeof
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nvme-cli
          sudo modprobe nvme-tcp || echo "nvme-tcp module already loaded"
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Destroy existing k3s cluster
        run: |
          echo "=== Destroying existing k3s cluster for clean state ==="
          if command -v k3s-uninstall.sh &> /dev/null; then
            sudo k3s-uninstall.sh || true
          fi
          sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s ~/.kube/config || true
      
      - name: Install k3s (fresh cluster)
        run: |
          echo "=== Installing fresh k3s cluster ==="
          curl -sfL https://get.k3s.io | sh -s - \
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --disable servicelb
          sleep 15
          retries=0
          while [[ $retries -lt 24 ]]; do
            if sudo k3s kubectl get nodes &>/dev/null; then
              if sudo k3s kubectl wait --for=condition=Ready node --all --timeout=10s 2>/dev/null; then
                echo "Fresh k3s cluster ready"
                exit 0
              fi
            fi
            sleep 5
            retries=$((retries + 1))
          done
          exit 1
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Run NVMe-oF StatefulSet Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-statefulset-nvmeof.sh

  integration-connection-resilience:
    name: Connection Resilience Tests
    runs-on: self-hosted
    needs: [integration-statefulset-nfs, integration-statefulset-nvmeof]
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nfs-common
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Destroy existing k3s cluster
        run: |
          echo "=== Destroying existing k3s cluster for clean state ==="
          if command -v k3s-uninstall.sh &> /dev/null; then
            sudo k3s-uninstall.sh || true
          fi
          sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s ~/.kube/config || true
      
      - name: Install k3s (fresh cluster)
        run: |
          echo "=== Installing fresh k3s cluster ==="
          curl -sfL https://get.k3s.io | sh -s - \
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --disable servicelb
          sleep 15
          retries=0
          while [[ $retries -lt 24 ]]; do
            if sudo k3s kubectl get nodes &>/dev/null; then
              if sudo k3s kubectl wait --for=condition=Ready node --all --timeout=10s 2>/dev/null; then
                echo "Fresh k3s cluster ready"
                exit 0
              fi
            fi
            sleep 5
            retries=$((retries + 1))
          done
          exit 1
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Run Connection Resilience Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-connection-resilience.sh

  integration-orphaned-resources:
    name: Orphaned Resource Detection Tests
    runs-on: self-hosted
    needs: integration-connection-resilience
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nfs-common nvme-cli jq
          sudo modprobe nvme-tcp || echo "nvme-tcp module already loaded"
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Destroy existing k3s cluster
        run: |
          echo "=== Destroying existing k3s cluster for clean state ==="
          if command -v k3s-uninstall.sh &> /dev/null; then
            sudo k3s-uninstall.sh || true
          fi
          sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s ~/.kube/config || true
      
      - name: Install k3s (fresh cluster)
        run: |
          echo "=== Installing fresh k3s cluster ==="
          curl -sfL https://get.k3s.io | sh -s - \
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --disable servicelb
          sleep 15
          retries=0
          while [[ $retries -lt 24 ]]; do
            if sudo k3s kubectl get nodes &>/dev/null; then
              if sudo k3s kubectl wait --for=condition=Ready node --all --timeout=10s 2>/dev/null; then
                echo "Fresh k3s cluster ready"
                exit 0
              fi
            fi
            sleep 5
            retries=$((retries + 1))
          done
          exit 1
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Run Orphaned Resource Detection Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-orphaned-resources.sh

  cleanup:
    name: Cleanup TrueNAS Artifacts
    runs-on: self-hosted
    needs: [integration-nfs, integration-nvmeof, integration-snapshot-nfs, integration-snapshot-nvmeof, integration-concurrent-nfs, integration-concurrent-nvmeof, integration-persistence-nfs, integration-persistence-nvmeof, integration-statefulset-nfs, integration-statefulset-nvmeof, integration-connection-resilience, integration-orphaned-resources]
    if: always()
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Run TrueNAS cleanup
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Running TrueNAS artifact cleanup ==="
          ./scripts/cleanup-truenas-artifacts.sh
          echo "=== Cleanup complete ==="
