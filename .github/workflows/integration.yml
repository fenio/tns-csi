name: Integration Tests

on:
  # push:
  #   branches: [ main ]
  #   paths-ignore:
  #     - '**.md'
  #     - 'docs/**'
  #     - 'README.md'
  #     - 'AGENTS.md'
  #     - 'CONTRIBUTING.md'
  #     - 'SECURITY.md'
  #     - 'LICENSE'
  # pull_request:
  #   branches: [ main ]
  #   paths-ignore:
  #     - '**.md'
  #     - 'docs/**'
  #     - 'README.md'
  #     - 'AGENTS.md'
  #     - 'CONTRIBUTING.md'
  #     - 'SECURITY.md'
  #     - 'LICENSE'
  workflow_dispatch:
    inputs:
      protocol:
        description: 'Protocol to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - nfs
          - nvmeof
      test:
        description: 'Specific test to run (leave empty for all tests of selected protocol)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - basic
          - snapshot
          - concurrent
          - persistence
          - statefulset
          - volume-expansion
          - dual-mount
          - connection-resilience
          - pod-restart
          - access-modes
          - snapshot-restore
          - volume-stress

jobs:
  # Compute the image tag from branch name (handles / -> - conversion)
  compute-tag:
    name: Compute Image Tag
    runs-on: self-hosted
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Compute image tag from branch
        id: tag
        run: |
          BRANCH="${{ github.ref_name }}"
          if [ "$BRANCH" = "main" ]; then
            TAG="latest"
          else
            # Sanitize branch name for docker tag (replace / with -)
            TAG=$(echo "$BRANCH" | sed 's/\//-/g')
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using image tag: $TAG (from branch: $BRANCH)"

  pre-cleanup:
    name: Pre-Test Cleanup
    runs-on: self-hosted
    timeout-minutes: 10
    needs: compute-tag
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'
          cache: false
      
      - name: Clean TrueNAS artifacts before tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Cleaning TrueNAS artifacts before test run ==="
          echo "This ensures tests start with a clean slate"
          ./scripts/cleanup-truenas-artifacts.sh
          echo "=== Pre-test cleanup complete ==="

  integration-nfs:
    name: NFS Integration Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'basic')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs
      - uses: ./.github/actions/setup-k3s
      - name: Run NFS Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-nfs.sh

  integration-nvmeof:
    name: NVMe-oF Integration Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'basic')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run NVMe-oF Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-nvmeof.sh

  integration-snapshot-nfs:
    name: NFS Snapshot Integration Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs
      - uses: ./.github/actions/setup-k3s
      - uses: ./.github/actions/setup-snapshots
      - name: Run NFS Snapshot Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-snapshot-nfs.sh

  integration-snapshot-nvmeof:
    name: NVMe-oF Snapshot Integration Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'snapshot')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - uses: ./.github/actions/setup-snapshots
      - name: Run NVMe-oF Snapshot Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-snapshot-nvmeof.sh

  integration-concurrent-nfs:
    name: NFS Concurrent Volume Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'concurrent')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs
      - uses: ./.github/actions/setup-k3s
      - name: Run NFS Concurrent Volume Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-concurrent-nfs.sh

  integration-concurrent-nvmeof:
    name: NVMe-oF Concurrent Volume Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'concurrent')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run NVMe-oF Concurrent Volume Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-concurrent-nvmeof.sh

  integration-persistence-nfs:
    name: NFS Data Persistence Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'persistence')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs
      - uses: ./.github/actions/setup-k3s
      - name: Run NFS Data Persistence Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-persistence-nfs.sh

  integration-persistence-nvmeof:
    name: NVMe-oF Data Persistence Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'persistence')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run NVMe-oF Data Persistence Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-persistence-nvmeof.sh

  integration-statefulset-nfs:
    name: NFS StatefulSet Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'statefulset')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs
      - uses: ./.github/actions/setup-k3s
      - name: Run NFS StatefulSet Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-statefulset-nfs.sh

  integration-statefulset-nvmeof:
    name: NVMe-oF StatefulSet Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'statefulset')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run NVMe-oF StatefulSet Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-statefulset-nvmeof.sh

  integration-dual-mount:
    name: Dual Mount Tests (NFS + NVMe-oF)
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'dual-mount')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run Dual Mount Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-dual-mount.sh

  integration-connection-resilience:
    name: Connection Resilience Tests
    runs-on: self-hosted
    timeout-minutes: 15
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'connection-resilience')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs
      - uses: ./.github/actions/setup-k3s
      - name: Run Connection Resilience Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-connection-resilience.sh

  integration-volume-expansion-nfs:
    name: NFS Volume Expansion Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'volume-expansion')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs
      - uses: ./.github/actions/setup-k3s
      - name: Run NFS Volume Expansion Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-volume-expansion-nfs.sh

  integration-volume-expansion-nvmeof:
    name: NVMe-oF Volume Expansion Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'volume-expansion')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run NVMe-oF Volume Expansion Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-volume-expansion-nvmeof.sh

  integration-pod-restart:
    name: Pod Restart and Reattachment Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'pod-restart')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run Pod Restart Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-pod-restart.sh

  integration-access-modes:
    name: Access Mode Validation Tests
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'access-modes')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run Access Mode Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-access-modes.sh

  integration-snapshot-restore:
    name: Snapshot Restore Verification Tests
    runs-on: self-hosted
    timeout-minutes: 20
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'snapshot-restore')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - uses: ./.github/actions/setup-snapshots
      - name: Run Snapshot Restore Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-snapshot-restore.sh

  integration-volume-stress:
    name: Volume Limits Stress Tests
    runs-on: self-hosted
    timeout-minutes: 15
    needs: [compute-tag, pre-cleanup]
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == '') &&
      (github.event.inputs.test == '' || github.event.inputs.test == 'volume-stress')
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof
      - uses: ./.github/actions/setup-k3s
      - name: Run Volume Stress Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: |
          ./tests/integration/test-volume-stress.sh

  cleanup:
    name: Cleanup TrueNAS Artifacts
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [integration-nfs, integration-nvmeof, integration-snapshot-nfs, integration-snapshot-nvmeof, integration-concurrent-nfs, integration-concurrent-nvmeof, integration-persistence-nfs, integration-persistence-nvmeof, integration-statefulset-nfs, integration-statefulset-nvmeof, integration-dual-mount, integration-connection-resilience, integration-volume-expansion-nfs, integration-volume-expansion-nvmeof, integration-pod-restart, integration-access-modes, integration-snapshot-restore, integration-volume-stress]
    if: always()
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'
          cache: false
      
      - name: Run TrueNAS cleanup
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Running TrueNAS artifact cleanup ==="
          ./scripts/cleanup-truenas-artifacts.sh
          echo "=== Cleanup complete ==="
