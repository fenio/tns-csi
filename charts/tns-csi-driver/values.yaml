# Default values for tns-csi-driver.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# TrueNAS connection settings
truenas:
  # TrueNAS API URL (WebSocket endpoint)
  # Format: wss://YOUR-TRUENAS-IP:PORT/api/current
  # Example: wss://truenas.example.com:443/api/current
  url: ""
  
  # TrueNAS API key
  # You can generate this in TrueNAS UI: System > API Keys
  apiKey: ""
  
  # Name of existing secret containing TrueNAS credentials
  # If set, url and apiKey above will be ignored
  # Secret should contain keys: 'url' and 'api-key'
  existingSecret: ""
  
  # Skip TLS certificate verification
  # Set to true if TrueNAS uses self-signed certificates
  # WARNING: Only enable this in trusted networks
  skipTLSVerify: false

# Image configuration
image:
  repository: bfenski/tns-csi
  pullPolicy: IfNotPresent
  # Image tag to use. If empty, defaults to the chart's appVersion.
  # For production, either:
  #   1. Use a specific chart version: helm install --version 0.8.0
  #   2. Pin the image tag explicitly: --set image.tag=v0.8.0
  # The "latest" tag is available but NOT recommended for production use.
  tag: ""

imagePullSecrets: []

# CSI Driver name
csiDriverName: tns.csi.io

# Controller configuration
controller:
  # Number of controller replicas (should be 1 for leader election)
  replicas: 1
  
  # Log verbosity level (0-5, higher = more verbose)
  # 0: Errors only
  # 2: Normal operation (default) - volume created/deleted messages
  # 4: Detailed operations - API calls, dataset queries
  # 5: Debug - request/response bodies, context dumps
  logLevel: 2
  
  # Enable debug mode (sets DEBUG_CSI=true, equivalent to logLevel 4+)
  debug: false
  
  # Metrics configuration
  metrics:
    # Enable Prometheus metrics endpoint
    enabled: true
    # Port to expose metrics on
    port: 8080
    # Create a Service for metrics
    service:
      enabled: true
      type: ClusterIP
      port: 8080
      # Optional clusterIP to use (leave empty for automatic assignment)
      clusterIP: ""
      # Additional annotations for the Service
      annotations: {}
      # Additional labels for the Service
      labels: {}
    # Create a ServiceMonitor for Prometheus Operator
    serviceMonitor:
      enabled: false
      # Namespace to create the ServiceMonitor in (defaults to release namespace)
      namespace: ""
      # Additional labels for ServiceMonitor (e.g., release: prometheus)
      labels: {}
      # Additional annotations for ServiceMonitor
      annotations: {}
      # Scrape interval
      interval: 30s
      # Scrape timeout
      scrapeTimeout: 10s
      # Relabelings to apply to samples before ingestion
      relabelings: []
      # MetricRelabelings to apply to samples before ingestion
      metricRelabelings: []
  
  # Resource requests and limits
  resources:
    requests:
      cpu: 10m
      memory: 20Mi
    limits:
      cpu: 200m
      memory: 200Mi
  
  # Node selector for controller pod
  nodeSelector: {}
  
  # Tolerations for controller pod
  tolerations: []
  
  # Affinity for controller pod
  affinity: {}

# Node plugin configuration
node:
  # Kubelet data directory path
  # Different Kubernetes distributions use different paths:
  # - Standard K8s, K3s, Minikube: /var/lib/kubelet
  # - K0s: /var/lib/k0s/kubelet
  # - OpenShift: /var/lib/kubelet
  kubeletPath: /var/lib/kubelet
  
  # Log verbosity level (0-5, higher = more verbose)
  # 0: Errors only
  # 2: Normal operation (default) - volume created/deleted messages
  # 4: Detailed operations - API calls, staging details
  # 5: Debug - request/response bodies, context dumps
  logLevel: 2
  
  # Enable debug mode (sets DEBUG_CSI=true, equivalent to logLevel 4+)
  debug: false
  
  # Resource requests and limits for node plugin
  resources:
    requests:
      cpu: 10m
      memory: 20Mi
    limits:
      cpu: 200m
      memory: 200Mi
  
  # Node selector for node pods
  nodeSelector: {}
  
  # Tolerations for node pods
  tolerations: []
  
  # Affinity for node pods
  affinity: {}
  
  # Update strategy for DaemonSet
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

# CSI sidecar images
sidecars:
  provisioner:
    image:
      repository: registry.k8s.io/sig-storage/csi-provisioner
      tag: v6.1.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 40Mi
      limits:
        cpu: 300m
        memory: 300Mi
  
  attacher:
    image:
      repository: registry.k8s.io/sig-storage/csi-attacher
      tag: v4.10.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 40Mi
      limits:
        cpu: 300m
        memory: 300Mi
  
  resizer:
    image:
      repository: registry.k8s.io/sig-storage/csi-resizer
      tag: v2.0.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 40Mi
      limits:
        cpu: 300m
        memory: 300Mi
  
  nodeDriverRegistrar:
    image:
      repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
      tag: v2.15.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 20Mi
      limits:
        cpu: 100m
        memory: 100Mi
  
  snapshotter:
    image:
      repository: registry.k8s.io/sig-storage/csi-snapshotter
      tag: v8.4.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 20Mi
      limits:
        cpu: 200m
        memory: 200Mi

# Storage class configuration
storageClasses:
  # NFS storage class
  nfs:
    enabled: true
    name: tns-csi-nfs
    # Set as default storage class
    isDefault: false
    # Storage pool name on TrueNAS
    pool: "storage"
    # TrueNAS server IP/hostname for NFS mounts
    # Replace with your TrueNAS server IP
    server: ""
    # Optional: Parent dataset (defaults to pool name if not specified)
    parentDataset: ""
    # Reclaim policy: Delete or Retain
    reclaimPolicy: Delete
    # Volume binding mode: Immediate or WaitForFirstConsumer
    volumeBindingMode: Immediate
    # Allow volume expansion
    allowVolumeExpansion: true
    # Mount options for NFS volumes
    # These are merged with driver defaults (vers=4.2, nolock on Linux)
    # User-specified options override defaults if there's a conflict
    # Example: ["hard", "nointr", "rsize=1048576", "wsize=1048576"]
    mountOptions: []
    # Additional parameters
    # Available parameters:
    #   deleteStrategy: "delete" or "retain"
    #     - "delete" (default): Volume is deleted when PVC is deleted
    #     - "retain": Volume is kept on TrueNAS when PVC is deleted (useful for data protection)
    #   zfs.compression: ZFS compression algorithm (e.g., "lz4", "zstd", "off")
    #   zfs.dedup: ZFS deduplication (e.g., "on", "off", "verify")
    #   zfs.atime: Access time updates (e.g., "on", "off")
    #   zfs.sync: Sync writes (e.g., "standard", "always", "disabled")
    #
    # Volume Name Templating:
    #   nameTemplate: Go template for volume names (e.g., "{{ .PVCNamespace }}-{{ .PVCName }}")
    #     Available variables: .PVCName, .PVCNamespace, .PVName
    #     Example: "{{ .PVCNamespace }}-{{ .PVCName }}" creates "production-myapp-data"
    #   namePrefix: Simple prefix to prepend to volume name (e.g., "prod-")
    #   nameSuffix: Simple suffix to append to volume name (e.g., "-data")
    #     Note: nameTemplate takes precedence over namePrefix/nameSuffix if both are specified
    #
    # Dataset Comment Templating:
    #   commentTemplate: Go template for dataset comments visible in TrueNAS UI
    #     Uses the same variables as nameTemplate: .PVCName, .PVCNamespace, .PVName
    #     Example: "{{ .PVCNamespace }}/{{ .PVCName }}" shows "production/myapp-data" in TrueNAS
    #     Comments are free-form text (no sanitization or length limits)
    #
    # Volume Adoption (for cluster migration):
    #   markAdoptable: "true" or "false"
    #     - When "true", newly created volumes are marked as adoptable
    #     - Adoptable volumes can be imported into a different cluster using 'kubectl tns-csi adopt'
    #   adoptExisting: "true" or "false"
    #     - When "true", the driver will adopt existing volumes that match the PVC name
    #     - Useful for migrating volumes between clusters or recovering from cluster failures
    #
    # Encryption (ZFS native encryption):
    #   encryption: "true" or "false"
    #     - Enables ZFS native encryption for the dataset
    #   encryptionAlgorithm: Algorithm to use (default: "AES-256-GCM")
    #     - Options: AES-256-GCM, AES-128-CCM, AES-192-CCM, AES-256-CCM, AES-128-GCM, AES-192-GCM
    #   encryptionGenerateKey: "true" to auto-generate encryption key
    #     - If true, TrueNAS generates and manages the encryption key
    #   To use passphrase or hex key, create a Secret and reference it with:
    #     csi.storage.k8s.io/provisioner-secret-name: <secret-name>
    #     csi.storage.k8s.io/provisioner-secret-namespace: <secret-namespace>
    #   Secret keys:
    #     - encryptionPassphrase: passphrase for encryption (min 8 chars)
    #     - encryptionKey: hex-encoded encryption key (64 chars for 256-bit)
    parameters: {}

  # NVMe-oF storage class (requires Linux with nvme-tcp kernel module)
  # IMPORTANT: Before enabling, ensure you have configured an NVMe-oF port
  # in TrueNAS (Shares > NVMe-oF Targets > Ports). The CSI driver automatically
  # creates a dedicated subsystem for each volume - no pre-configured subsystem needed.
  nvmeof:
    enabled: false
    name: tns-csi-nvmeof
    isDefault: false
    # Storage pool name on TrueNAS
    pool: "storage"
    # TrueNAS server IP/hostname for NVMe-oF target
    server: ""
    # Optional: Parent dataset
    parentDataset: ""
    # NVMe-oF transport: tcp or rdma
    transport: "tcp"
    # NVMe-oF port number
    port: "4420"
    # Filesystem type for formatted volumes (ext4, ext3, xfs)
    fsType: "ext4"
    reclaimPolicy: Delete
    # NOTE: Must use Immediate for snapshot restore to work correctly.
    # WaitForFirstConsumer causes csi-provisioner to not pass VolumeContentSource
    # (snapshot reference) to CreateVolume, resulting in empty volumes instead of clones.
    volumeBindingMode: Immediate
    allowVolumeExpansion: true
    # Mount options for NVMe-oF filesystem volumes
    # These are merged with driver defaults (noatime)
    # User-specified options override defaults if there's a conflict
    # Example: ["discard", "nodiscard", "data=ordered"]
    mountOptions: []
    # Additional parameters
    # Available parameters:
    #   deleteStrategy: "delete" or "retain"
    #     - "delete" (default): Volume is deleted when PVC is deleted
    #     - "retain": Volume is kept on TrueNAS when PVC is deleted (useful for data protection)
    #   zfs.compression: ZFS compression algorithm (e.g., "lz4", "zstd", "off")
    #   zfs.dedup: ZFS deduplication (e.g., "on", "off", "verify")
    #   zfs.sync: Sync writes (e.g., "standard", "always", "disabled")
    #   zfs.volblocksize: ZVOL block size (e.g., "16K", "64K")
    #
    # Volume Name Templating:
    #   nameTemplate: Go template for volume names (e.g., "{{ .PVCNamespace }}-{{ .PVCName }}")
    #     Available variables: .PVCName, .PVCNamespace, .PVName
    #     Example: "{{ .PVCNamespace }}-{{ .PVCName }}" creates "production-myapp-data"
    #   namePrefix: Simple prefix to prepend to volume name (e.g., "prod-")
    #   nameSuffix: Simple suffix to append to volume name (e.g., "-data")
    #     Note: nameTemplate takes precedence over namePrefix/nameSuffix if both are specified
    #
    # Dataset Comment Templating:
    #   commentTemplate: Go template for dataset comments visible in TrueNAS UI
    #     Uses the same variables as nameTemplate: .PVCName, .PVCNamespace, .PVName
    #     Example: "{{ .PVCNamespace }}/{{ .PVCName }}" shows "production/myapp-data" in TrueNAS
    #     Comments are free-form text (no sanitization or length limits)
    #
    # Volume Adoption (for cluster migration):
    #   markAdoptable: "true" or "false"
    #     - When "true", newly created volumes are marked as adoptable
    #     - Adoptable volumes can be imported into a different cluster using 'kubectl tns-csi adopt'
    #   adoptExisting: "true" or "false"
    #     - When "true", the driver will adopt existing volumes that match the PVC name
    #     - Useful for migrating volumes between clusters or recovering from cluster failures
    #
    # NVMe-oF Specific:
    #   portID: TrueNAS NVMe-oF port ID to use
    #     - If not specified, the driver auto-detects the first available port
    #     - Useful when multiple NVMe-oF ports are configured on TrueNAS
    #
    # Encryption (ZFS native encryption):
    #   encryption: "true" or "false"
    #     - Enables ZFS native encryption for the ZVOL
    #   encryptionAlgorithm: Algorithm to use (default: "AES-256-GCM")
    #     - Options: AES-256-GCM, AES-128-CCM, AES-192-CCM, AES-256-CCM, AES-128-GCM, AES-192-GCM
    #   encryptionGenerateKey: "true" to auto-generate encryption key
    #     - If true, TrueNAS generates and manages the encryption key
    #   To use passphrase or hex key, create a Secret and reference it with:
    #     csi.storage.k8s.io/provisioner-secret-name: <secret-name>
    #     csi.storage.k8s.io/provisioner-secret-namespace: <secret-namespace>
    #   Secret keys:
    #     - encryptionPassphrase: passphrase for encryption (min 8 chars)
    #     - encryptionKey: hex-encoded encryption key (64 chars for 256-bit)
    parameters: {}

  # iSCSI storage class (requires open-iscsi on nodes)
  # IMPORTANT: Before enabling, ensure you have configured an iSCSI portal
  # in TrueNAS (Shares > iSCSI). The CSI driver automatically creates a
  # dedicated target for each volume - no pre-configured target needed.
  iscsi:
    enabled: false
    name: tns-csi-iscsi
    isDefault: false
    # Storage pool name on TrueNAS
    pool: "storage"
    # TrueNAS server IP/hostname for iSCSI target
    server: ""
    # Optional: Parent dataset
    parentDataset: ""
    # iSCSI port number
    port: "3260"
    # Filesystem type for formatted volumes (ext4, ext3, xfs)
    fsType: "ext4"
    reclaimPolicy: Delete
    # NOTE: Must use Immediate for snapshot restore to work correctly.
    # WaitForFirstConsumer causes csi-provisioner to not pass VolumeContentSource
    # (snapshot reference) to CreateVolume, resulting in empty volumes instead of clones.
    volumeBindingMode: Immediate
    allowVolumeExpansion: true
    # Mount options for iSCSI filesystem volumes
    # These are merged with driver defaults (noatime, _netdev)
    # User-specified options override defaults if there's a conflict
    # Example: ["discard", "data=ordered"]
    mountOptions: []
    # Additional parameters
    # Available parameters:
    #   deleteStrategy: "delete" or "retain"
    #     - "delete" (default): Volume is deleted when PVC is deleted
    #     - "retain": Volume is kept on TrueNAS when PVC is deleted (useful for data protection)
    #   zfs.compression: ZFS compression algorithm (e.g., "lz4", "zstd", "off")
    #   zfs.dedup: ZFS deduplication (e.g., "on", "off", "verify")
    #   zfs.sync: Sync writes (e.g., "standard", "always", "disabled")
    #   zfs.volblocksize: ZVOL block size (e.g., "16K", "64K")
    #
    # Volume Name Templating:
    #   nameTemplate: Go template for volume names (e.g., "{{ .PVCNamespace }}-{{ .PVCName }}")
    #     Available variables: .PVCName, .PVCNamespace, .PVName
    #     Example: "{{ .PVCNamespace }}-{{ .PVCName }}" creates "production-myapp-data"
    #   namePrefix: Simple prefix to prepend to volume name (e.g., "prod-")
    #   nameSuffix: Simple suffix to append to volume name (e.g., "-data")
    #     Note: nameTemplate takes precedence over namePrefix/nameSuffix if both are specified
    #
    # Dataset Comment Templating:
    #   commentTemplate: Go template for dataset comments visible in TrueNAS UI
    #     Uses the same variables as nameTemplate: .PVCName, .PVCNamespace, .PVName
    #     Example: "{{ .PVCNamespace }}/{{ .PVCName }}" shows "production/myapp-data" in TrueNAS
    #     Comments are free-form text (no sanitization or length limits)
    #
    # Volume Adoption (for cluster migration):
    #   markAdoptable: "true" or "false"
    #     - When "true", newly created volumes are marked as adoptable
    #     - Adoptable volumes can be imported into a different cluster using 'kubectl tns-csi adopt'
    #   adoptExisting: "true" or "false"
    #     - When "true", the driver will adopt existing volumes that match the PVC name
    #     - Useful for migrating volumes between clusters or recovering from cluster failures
    #
    # Encryption (ZFS native encryption):
    #   encryption: "true" or "false"
    #     - Enables ZFS native encryption for the ZVOL
    #   encryptionAlgorithm: Algorithm to use (default: "AES-256-GCM")
    #     - Options: AES-256-GCM, AES-128-CCM, AES-192-CCM, AES-256-CCM, AES-128-GCM, AES-192-GCM
    #   encryptionGenerateKey: "true" to auto-generate encryption key
    #     - If true, TrueNAS generates and manages the encryption key
    #   To use passphrase or hex key, create a Secret and reference it with:
    #     csi.storage.k8s.io/provisioner-secret-name: <secret-name>
    #     csi.storage.k8s.io/provisioner-secret-namespace: <secret-namespace>
    #   Secret keys:
    #     - encryptionPassphrase: passphrase for encryption (min 8 chars)
    #     - encryptionKey: hex-encoded encryption key (64 chars for 256-bit)
    parameters: {}

# Snapshot support
snapshots:
  # Enable snapshot support (adds csi-snapshotter sidecar to controller)
  # NOTE: Requires VolumeSnapshot CRDs to be installed in the cluster first
  # Install with: kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/...
  enabled: false
  
  # VolumeSnapshotClass configuration
  # VolumeSnapshotClass resources will be created for enabled storage classes
  volumeSnapshotClass:
    # Enable creation of VolumeSnapshotClass resources
    create: true
    # Deletion policy: Delete or Retain
    deletionPolicy: Delete
  
  # Detached snapshots configuration
  # Detached snapshots use zfs send/receive to create independent dataset copies
  # that survive deletion of the source volume. Useful for backup/DR scenarios.
  detached:
    # Enable detached VolumeSnapshotClass creation
    # When enabled, a separate "-snapshot-detached" class will be created
    enabled: false
    # Parent dataset for detached snapshots (optional)
    # If not specified, defaults to {pool}/csi-detached-snapshots
    # Example: "tank/backups/csi-snapshots"
    parentDataset: ""
    # Deletion policy for detached snapshots
    deletionPolicy: Delete

# Security context for controller pod
securityContext:
  runAsNonRoot: false
  runAsUser: 0
  fsGroup: 0

# Priority class names
priorityClassName:
  controller: system-cluster-critical
  node: system-node-critical

# Service account configuration
serviceAccount:
  # Annotations to add to the service accounts
  annotations: {}

# Namespace where the CSI driver will be deployed
namespace: kube-system

# RBAC configuration
rbac:
  # Create RBAC resources
  create: true

# Custom labels to add to all resources
customLabels: {}

# Custom annotations to add to all resources
customAnnotations: {}
