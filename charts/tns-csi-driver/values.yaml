# Default values for tns-csi-driver.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# TrueNAS connection settings
truenas:
  # TrueNAS API URL (WebSocket endpoint)
  # Format: wss://YOUR-TRUENAS-IP:PORT/api/current
  # Example: wss://truenas.example.com:443/api/current
  url: ""
  
  # TrueNAS API key
  # You can generate this in TrueNAS UI: System > API Keys
  apiKey: ""
  
  # Name of existing secret containing TrueNAS credentials
  # If set, url and apiKey above will be ignored
  # Secret should contain keys: 'url' and 'api-key'
  existingSecret: ""
  
  # Skip TLS certificate verification
  # Set to true if TrueNAS uses self-signed certificates
  # WARNING: Only enable this in trusted networks
  skipTLSVerify: false

# Image configuration
image:
  repository: bfenski/tns-csi
  pullPolicy: Always
  tag: "latest"

imagePullSecrets: []

# CSI Driver name
csiDriverName: tns.csi.io

# Controller configuration
controller:
  # Number of controller replicas (should be 1 for leader election)
  replicas: 1
  
  # Log verbosity level (0-5, higher = more verbose)
  # 0: Errors only
  # 2: Normal operation (default) - volume created/deleted messages
  # 4: Detailed operations - API calls, dataset queries
  # 5: Debug - request/response bodies, context dumps
  logLevel: 2
  
  # Enable debug mode (sets DEBUG_CSI=true, equivalent to logLevel 4+)
  debug: false
  
  # Metrics configuration
  metrics:
    # Enable Prometheus metrics endpoint
    enabled: true
    # Port to expose metrics on
    port: 8080
    # Create a Service for metrics
    service:
      enabled: true
      type: ClusterIP
      port: 8080
      # Optional clusterIP to use (leave empty for automatic assignment)
      clusterIP: ""
      # Additional annotations for the Service
      annotations: {}
      # Additional labels for the Service
      labels: {}
    # Create a ServiceMonitor for Prometheus Operator
    serviceMonitor:
      enabled: false
      # Namespace to create the ServiceMonitor in (defaults to release namespace)
      namespace: ""
      # Additional labels for ServiceMonitor (e.g., release: prometheus)
      labels: {}
      # Additional annotations for ServiceMonitor
      annotations: {}
      # Scrape interval
      interval: 30s
      # Scrape timeout
      scrapeTimeout: 10s
      # Relabelings to apply to samples before ingestion
      relabelings: []
      # MetricRelabelings to apply to samples before ingestion
      metricRelabelings: []
  
  # Resource requests and limits
  resources:
    requests:
      cpu: 10m
      memory: 20Mi
    limits:
      cpu: 200m
      memory: 200Mi
  
  # Node selector for controller pod
  nodeSelector: {}
  
  # Tolerations for controller pod
  tolerations: []
  
  # Affinity for controller pod
  affinity: {}

# Node plugin configuration
node:
  # Kubelet data directory path
  # Different Kubernetes distributions use different paths:
  # - Standard K8s, K3s, Minikube: /var/lib/kubelet
  # - K0s: /var/lib/k0s/kubelet
  # - OpenShift: /var/lib/kubelet
  kubeletPath: /var/lib/kubelet
  
  # Log verbosity level (0-5, higher = more verbose)
  # 0: Errors only
  # 2: Normal operation (default) - volume created/deleted messages
  # 4: Detailed operations - API calls, staging details
  # 5: Debug - request/response bodies, context dumps
  logLevel: 2
  
  # Enable debug mode (sets DEBUG_CSI=true, equivalent to logLevel 4+)
  debug: false
  
  # Resource requests and limits for node plugin
  resources:
    requests:
      cpu: 10m
      memory: 20Mi
    limits:
      cpu: 200m
      memory: 200Mi
  
  # Node selector for node pods
  nodeSelector: {}
  
  # Tolerations for node pods
  tolerations: []
  
  # Affinity for node pods
  affinity: {}
  
  # Update strategy for DaemonSet
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

# CSI sidecar images
sidecars:
  provisioner:
    image:
      repository: registry.k8s.io/sig-storage/csi-provisioner
      tag: v6.1.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 40Mi
      limits:
        cpu: 300m
        memory: 300Mi
  
  attacher:
    image:
      repository: registry.k8s.io/sig-storage/csi-attacher
      tag: v4.10.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 40Mi
      limits:
        cpu: 300m
        memory: 300Mi
  
  resizer:
    image:
      repository: registry.k8s.io/sig-storage/csi-resizer
      tag: v2.0.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 40Mi
      limits:
        cpu: 300m
        memory: 300Mi
  
  nodeDriverRegistrar:
    image:
      repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
      tag: v2.15.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 20Mi
      limits:
        cpu: 100m
        memory: 100Mi
  
  snapshotter:
    image:
      repository: registry.k8s.io/sig-storage/csi-snapshotter
      tag: v8.4.0
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 10m
        memory: 20Mi
      limits:
        cpu: 200m
        memory: 200Mi

# Storage class configuration
storageClasses:
  # NFS storage class
  nfs:
    enabled: true
    name: tns-csi-nfs
    # Set as default storage class
    isDefault: false
    # Storage pool name on TrueNAS
    pool: "storage"
    # TrueNAS server IP/hostname for NFS mounts
    # Replace with your TrueNAS server IP
    server: ""
    # Optional: Parent dataset (defaults to pool name if not specified)
    parentDataset: ""
    # Reclaim policy: Delete or Retain
    reclaimPolicy: Delete
    # Volume binding mode: Immediate or WaitForFirstConsumer
    volumeBindingMode: Immediate
    # Allow volume expansion
    allowVolumeExpansion: true
    # Mount options for NFS volumes
    # These are merged with driver defaults (vers=4.2, nolock on Linux)
    # User-specified options override defaults if there's a conflict
    # Example: ["hard", "nointr", "rsize=1048576", "wsize=1048576"]
    mountOptions: []
    # Additional parameters
    parameters: {}
  
  # NVMe-oF storage class (requires Linux with nvme-tcp kernel module)
  # IMPORTANT: Before enabling, ensure you have configured an NVMe-oF port
  # in TrueNAS (Shares > NVMe-oF Targets > Ports). The CSI driver automatically
  # creates a dedicated subsystem for each volume - no pre-configured subsystem needed.
  nvmeof:
    enabled: false
    name: tns-csi-nvmeof
    isDefault: false
    # Storage pool name on TrueNAS
    pool: "storage"
    # TrueNAS server IP/hostname for NVMe-oF target
    server: ""
    # Optional: Parent dataset
    parentDataset: ""
    # NVMe-oF transport: tcp or rdma
    transport: "tcp"
    # NVMe-oF port number
    port: "4420"
    # Filesystem type for formatted volumes (ext4, ext3, xfs)
    fsType: "ext4"
    reclaimPolicy: Delete
    # NOTE: Must use Immediate for snapshot restore to work correctly.
    # WaitForFirstConsumer causes csi-provisioner to not pass VolumeContentSource
    # (snapshot reference) to CreateVolume, resulting in empty volumes instead of clones.
    volumeBindingMode: Immediate
    allowVolumeExpansion: true
    # Mount options for NVMe-oF filesystem volumes
    # These are merged with driver defaults (noatime)
    # User-specified options override defaults if there's a conflict
    # Example: ["discard", "nodiscard", "data=ordered"]
    mountOptions: []
    parameters: {}

# Snapshot support
snapshots:
  # Enable snapshot support (adds csi-snapshotter sidecar to controller)
  # NOTE: Requires VolumeSnapshot CRDs to be installed in the cluster first
  # Install with: kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/release-8.2/client/config/crd/...
  enabled: false
  
  # VolumeSnapshotClass configuration
  # VolumeSnapshotClass resources will be created for enabled storage classes
  volumeSnapshotClass:
    # Enable creation of VolumeSnapshotClass resources
    create: true
    # Deletion policy: Delete or Retain
    deletionPolicy: Delete

# Security context for controller pod
securityContext:
  runAsNonRoot: false
  runAsUser: 0
  fsGroup: 0

# Priority class names
priorityClassName:
  controller: system-cluster-critical
  node: system-node-critical

# Service account configuration
serviceAccount:
  # Annotations to add to the service accounts
  annotations: {}

# Namespace where the CSI driver will be deployed
namespace: kube-system

# RBAC configuration
rbac:
  # Create RBAC resources
  create: true

# Custom labels to add to all resources
customLabels: {}

# Custom annotations to add to all resources
customAnnotations: {}
