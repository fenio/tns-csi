name: E2E Tests (Go)

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - nfs
          - nvmeof
      focus:
        description: 'Ginkgo focus filter (regex pattern to match test names)'
        required: false
        default: ''
        type: string

# Restrict permissions to minimum required
permissions:
  contents: read

# Ensure only one E2E test runs at a time on the runner
concurrency:
  group: e2e-tests-go
  cancel-in-progress: false

jobs:
  e2e-nfs:
    name: "E2E: NFS"
    runs-on: new
    timeout-minutes: 20
    if: github.event.inputs.suite == 'all' || github.event.inputs.suite == 'nfs' || github.event.inputs.suite == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup k3s
        uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'

      - name: Run NFS E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: latest
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        working-directory: tests/e2e
        run: |
          FOCUS_ARG=""
          if [ -n "${{ github.event.inputs.focus }}" ]; then
            FOCUS_ARG="-ginkgo.focus=${{ github.event.inputs.focus }}"
          fi
          
          go test -v -timeout 15m ./nfs/... \
            -ginkgo.v \
            -ginkgo.no-color \
            ${FOCUS_ARG} \
            -ginkgo.junit-report=junit-nfs.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-results-nfs
          path: tests/e2e/junit-*.xml
          retention-days: 7

      - name: Upload Diagnostic Logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-diagnostics-nfs
          path: /tmp/e2e-logs/
          retention-days: 7

  e2e-nvmeof:
    name: "E2E: NVMe-oF"
    runs-on: new
    timeout-minutes: 20
    if: github.event.inputs.suite == 'all' || github.event.inputs.suite == 'nvmeof'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup k3s
        uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'

      - name: Run NVMe-oF E2E Tests
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: latest
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        working-directory: tests/e2e
        run: |
          FOCUS_ARG=""
          if [ -n "${{ github.event.inputs.focus }}" ]; then
            FOCUS_ARG="-ginkgo.focus=${{ github.event.inputs.focus }}"
          fi
          
          go test -v -timeout 15m ./nvmeof/... \
            -ginkgo.v \
            -ginkgo.no-color \
            ${FOCUS_ARG} \
            -ginkgo.junit-report=junit-nvmeof.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-results-nvmeof
          path: tests/e2e/junit-*.xml
          retention-days: 7

      - name: Upload Diagnostic Logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-diagnostics-nvmeof
          path: /tmp/e2e-logs/
          retention-days: 7

  summary:
    name: "E2E Summary"
    runs-on: new
    needs: [e2e-nfs, e2e-nvmeof]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.e2e-nfs.result }}" == "success" ]; then
            echo "- :white_check_mark: NFS: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.e2e-nfs.result }}" == "skipped" ]; then
            echo "- :fast_forward: NFS: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :x: NFS: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.e2e-nvmeof.result }}" == "success" ]; then
            echo "- :white_check_mark: NVMe-oF: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.e2e-nvmeof.result }}" == "skipped" ]; then
            echo "- :fast_forward: NVMe-oF: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- :x: NVMe-oF: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail if any required job failed
          if [ "${{ needs.e2e-nfs.result }}" == "failure" ] || [ "${{ needs.e2e-nvmeof.result }}" == "failure" ]; then
            echo ""
            echo "One or more E2E test suites failed."
            exit 1
          fi
