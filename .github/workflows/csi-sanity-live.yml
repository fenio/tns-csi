name: CSI Sanity Live Tests

'on':
  push:
    branches:
      - main
      - 'feature/csi-sanity-live'
    paths:
      - 'pkg/**'
      - 'cmd/**'
      - 'tests/sanity-live/**'
      - 'go.mod'
      - 'go.sum'
      - 'charts/**'
      - 'Dockerfile'
      - '.github/workflows/csi-sanity-live.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'pkg/**'
      - 'cmd/**'
      - 'tests/sanity-live/**'
      - 'go.mod'
      - 'go.sum'
      - 'charts/**'
      - 'Dockerfile'
      - '.github/workflows/csi-sanity-live.yml'
  workflow_dispatch:

jobs:
  sanity-live-nfs:
    name: CSI Sanity Live Tests (NFS)
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v5

      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nfs

      - uses: ./.github/actions/setup-k3s

      - name: Install csi-sanity
        run: |
          echo "=== Installing csi-sanity ==="
          go install github.com/kubernetes-csi/csi-test/v5/cmd/csi-sanity@latest
          echo "csi-sanity version:"
          ~/go/bin/csi-sanity --version || echo "No version flag available"

      - name: Deploy CSI Driver (NFS)
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Deploying tns-csi-driver with NFS protocol ==="

          # Construct TrueNAS WebSocket URL
          TRUENAS_URL="wss://${TRUENAS_HOST}/api/current"
          echo "TrueNAS URL: ${TRUENAS_URL}"

          # Install using Helm
          helm upgrade --install tns-csi-driver ./charts/tns-csi-driver \
            --namespace kube-system \
            --create-namespace \
            --set truenas.url="${TRUENAS_URL}" \
            --set truenas.apiKey="${TRUENAS_API_KEY}" \
            --set storageClasses.nfs.enabled=true \
            --set storageClasses.nfs.name=tns-csi-nfs \
            --set storageClasses.nfs.pool="${TRUENAS_POOL}" \
            --set storageClasses.nfs.server="${TRUENAS_HOST}" \
            --set storageClasses.nvmeof.enabled=false \
            --set image.repository=bfenski/tns-csi \
            --set image.tag=latest \
            --set image.pullPolicy=Never \
            --wait --timeout=5m

          echo "=== Waiting for CSI driver pods to be ready ==="
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=tns-csi-driver \
            -n kube-system --timeout=300s

          echo "=== CSI Driver Status ==="
          kubectl get pods -n kube-system -l app.kubernetes.io/name=tns-csi-driver
          kubectl get csidrivers

      - name: Run csi-sanity tests (NFS)
        run: |
          ./tests/sanity-live/test-csi-sanity-live.sh nfs

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Controller logs ==="
          kubectl logs -n kube-system \
            -l app.kubernetes.io/name=tns-csi-driver,app.kubernetes.io/component=controller \
            --tail=100 || true
          echo "=== Node logs ==="
          kubectl logs -n kube-system \
            -l app.kubernetes.io/name=tns-csi-driver,app.kubernetes.io/component=node \
            --tail=100 || true

  sanity-live-nvmeof:
    name: CSI Sanity Live Tests (NVMe-oF)
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v5

      - uses: ./.github/actions/setup-dependencies
        with:
          protocol: nvmeof

      - uses: ./.github/actions/setup-k3s

      - name: Install csi-sanity
        run: |
          echo "=== Installing csi-sanity ==="
          go install github.com/kubernetes-csi/csi-test/v5/cmd/csi-sanity@latest
          echo "csi-sanity version:"
          ~/go/bin/csi-sanity --version || echo "No version flag available"

      - name: Deploy CSI Driver (NVMe-oF)
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Deploying tns-csi-driver with NVMe-oF protocol ==="

          # Construct TrueNAS WebSocket URL
          TRUENAS_URL="wss://${TRUENAS_HOST}/api/current"
          echo "TrueNAS URL: ${TRUENAS_URL}"

          # NVMe-oF subsystem NQN - use env var or default
          SUBSYSTEM_NQN="${NVMEOF_SUBSYSTEM_NQN:-nqn.2005-03.org.truenas:csi-test}"

          # Install using Helm
          helm upgrade --install tns-csi-driver ./charts/tns-csi-driver \
            --namespace kube-system \
            --create-namespace \
            --set truenas.url="${TRUENAS_URL}" \
            --set truenas.apiKey="${TRUENAS_API_KEY}" \
            --set storageClasses.nfs.enabled=false \
            --set storageClasses.nvmeof.enabled=true \
            --set storageClasses.nvmeof.name=tns-csi-nvmeof \
            --set storageClasses.nvmeof.pool="${TRUENAS_POOL}" \
            --set storageClasses.nvmeof.server="${TRUENAS_HOST}" \
            --set storageClasses.nvmeof.transport=tcp \
            --set storageClasses.nvmeof.port=4420 \
            --set storageClasses.nvmeof.subsystemNQN="${SUBSYSTEM_NQN}" \
            --set image.repository=bfenski/tns-csi \
            --set image.tag=latest \
            --set image.pullPolicy=Never \
            --wait --timeout=5m

          echo "=== Waiting for CSI driver pods to be ready ==="
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=tns-csi-driver \
            -n kube-system --timeout=300s

          echo "=== CSI Driver Status ==="
          kubectl get pods -n kube-system -l app.kubernetes.io/name=tns-csi-driver
          kubectl get csidrivers

      - name: Run csi-sanity tests (NVMe-oF)
        run: |
          ./tests/sanity-live/test-csi-sanity-live.sh nvmeof

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Controller logs ==="
          kubectl logs -n kube-system \
            -l app.kubernetes.io/name=tns-csi-driver,app.kubernetes.io/component=controller \
            --tail=100 || true
          echo "=== Node logs ==="
          kubectl logs -n kube-system \
            -l app.kubernetes.io/name=tns-csi-driver,app.kubernetes.io/component=node \
            --tail=100 || true

  cleanup:
    name: Cleanup After Sanity Tests
    runs-on: self-hosted
    needs: [sanity-live-nfs, sanity-live-nvmeof]
    if: always()
    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false

      - name: Run TrueNAS cleanup
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Running TrueNAS artifact cleanup ==="
          ./scripts/cleanup-truenas-artifacts.sh
          echo "=== Cleanup complete ==="
