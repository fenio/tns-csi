name: PVC Lifecycle Tests

on:
  # Manual trigger for testing PVC lifecycle behavior
  workflow_dispatch:
    inputs:
      protocol:
        description: 'Protocol to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - nfs
          - nvmeof
          - nvmeof-nested

# Restrict permissions to minimum required
permissions:
  contents: read

# Ensure only one integration test runs at a time on the runner
concurrency:
  group: pvc-lifecycle-tests
  cancel-in-progress: false

jobs:
  # ==========================================
  # Setup Phase
  # ==========================================
  compute-tag:
    name: Compute Image Tag
    runs-on: new
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Compute image tag from branch
        id: tag
        run: |
          BRANCH="${{ github.ref_name }}"
          if [ "$BRANCH" = "main" ]; then
            TAG="latest"
          else
            TAG=$(echo "$BRANCH" | sed 's/\//-/g')
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using image tag: $TAG (from branch: $BRANCH)"

  # ==========================================
  # NFS PVC Lifecycle Test
  # ==========================================
  nfs-pvc-lifecycle:
    name: "NFS: PVC Lifecycle"
    runs-on: new
    timeout-minutes: 15
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nfs' || github.event.inputs.protocol == '')
    steps:
      - uses: actions/checkout@v6
      - name: Install websocat
        run: |
          # Download websocat binary with retries and -f to fail on HTTP errors
          for i in 1 2 3; do
            curl -fsSL https://github.com/vi/websocat/releases/download/v1.14.0/websocat.x86_64-unknown-linux-musl -o /tmp/websocat && break
            echo "Download attempt $i failed, retrying in 5s..."
            sleep 5
          done
          # Verify it's a binary not an HTML error page
          if file /tmp/websocat | grep -q "ELF"; then
            chmod +x /tmp/websocat
            sudo mv /tmp/websocat /usr/local/bin/websocat
            websocat --version
          else
            echo "ERROR: Downloaded file is not a valid ELF binary"
            file /tmp/websocat
            head -c 200 /tmp/websocat
            exit 1
          fi
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-pvc-lifecycle-nfs.sh
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: nfs-pvc-lifecycle-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  # ==========================================
  # NVMe-oF PVC Lifecycle Test
  # ==========================================
  nvmeof-pvc-lifecycle:
    name: "NVMe-oF: PVC Lifecycle"
    runs-on: new
    timeout-minutes: 15
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof' || github.event.inputs.protocol == '')
    steps:
      - uses: actions/checkout@v6
      - name: Install websocat
        run: |
          # Download websocat binary with retries and -f to fail on HTTP errors
          for i in 1 2 3; do
            curl -fsSL https://github.com/vi/websocat/releases/download/v1.14.0/websocat.x86_64-unknown-linux-musl -o /tmp/websocat && break
            echo "Download attempt $i failed, retrying in 5s..."
            sleep 5
          done
          # Verify it's a binary not an HTML error page
          if file /tmp/websocat | grep -q "ELF"; then
            chmod +x /tmp/websocat
            sudo mv /tmp/websocat /usr/local/bin/websocat
            websocat --version
          else
            echo "ERROR: Downloaded file is not a valid ELF binary"
            file /tmp/websocat
            head -c 200 /tmp/websocat
            exit 1
          fi
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
        run: ./tests/integration/test-pvc-lifecycle-nvmeof.sh
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: nvmeof-pvc-lifecycle-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  # ==========================================
  # NVMe-oF PVC Lifecycle Test with Nested Dataset
  # Tests scenario from user with democratic-csi migration
  # ==========================================
  nvmeof-nested-pvc-lifecycle:
    name: "NVMe-oF: PVC Lifecycle (Nested Dataset)"
    runs-on: new
    timeout-minutes: 20
    needs: compute-tag
    if: |
      (github.event.inputs.protocol == 'all' || github.event.inputs.protocol == 'nvmeof-nested' || github.event.inputs.protocol == '')
    steps:
      - uses: actions/checkout@v6
      - name: Install websocat
        run: |
          # Download websocat binary with retries and -f to fail on HTTP errors
          for i in 1 2 3; do
            curl -fsSL https://github.com/vi/websocat/releases/download/v1.14.0/websocat.x86_64-unknown-linux-musl -o /tmp/websocat && break
            echo "Download attempt $i failed, retrying in 5s..."
            sleep 5
          done
          # Verify it's a binary not an HTML error page
          if file /tmp/websocat | grep -q "ELF"; then
            chmod +x /tmp/websocat
            sudo mv /tmp/websocat /usr/local/bin/websocat
            websocat --version
          else
            echo "ERROR: Downloaded file is not a valid ELF binary"
            file /tmp/websocat
            head -c 200 /tmp/websocat
            exit 1
          fi
      - uses: fenio/setup-k3s@v5
        with:
          k3s-args: '--write-kubeconfig-mode 644 --disable=traefik --disable=local-storage'
      - name: Run Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
          CSI_IMAGE_TAG: ${{ needs.compute-tag.outputs.image_tag }}
          # Use the existing nested dataset path if available, or use test path
          TRUENAS_NESTED_DATASET: ${{ secrets.TRUENAS_NESTED_DATASET || 'csi-test/nested/volumes' }}
        run: ./tests/integration/test-pvc-lifecycle-nested-dataset.sh
      - name: Upload diagnostic logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: nvmeof-nested-pvc-lifecycle-diagnostics
          path: /tmp/test-logs/
          retention-days: 7

  # ==========================================
  # Summary
  # ==========================================
  test-summary:
    name: "Test Summary"
    runs-on: new
    timeout-minutes: 5
    needs: [nfs-pvc-lifecycle, nvmeof-pvc-lifecycle, nvmeof-nested-pvc-lifecycle]
    if: always()
    steps:
      - name: Generate Test Summary
        uses: actions/github-script@v8
        with:
          script: |
            const results = {
              'NFS PVC Lifecycle': '${{ needs.nfs-pvc-lifecycle.result }}',
              'NVMe-oF PVC Lifecycle': '${{ needs.nvmeof-pvc-lifecycle.result }}',
              'NVMe-oF PVC Lifecycle (Nested Dataset)': '${{ needs.nvmeof-nested-pvc-lifecycle.result }}',
            };
            
            const getIcon = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'skipped': return 'â­ï¸';
                case 'cancelled': return 'ðŸš«';
                default: return 'âšª';
              }
            };
            
            let passed = 0, failed = 0, skipped = 0;
            for (const result of Object.values(results)) {
              if (result === 'success') passed++;
              else if (result === 'failure') failed++;
              else if (result === 'skipped') skipped++;
            }
            
            let summary = `# PVC Lifecycle Test Results\n\n`;
            summary += `This workflow tests the PVC create/bind/delete lifecycle WITHOUT pod attachment.\n`;
            summary += `It isolates the CSI controller provisioning and deletion behavior.\n\n`;
            
            // Overall status banner
            if (failed > 0) {
              summary += `> ### ${failed} test(s) failed\n\n`;
            } else if (passed === 3) {
              summary += `> ### All tests passed!\n\n`;
            } else {
              summary += `> ### ${passed}/${passed + failed} tests passed (${skipped} skipped)\n\n`;
            }
            
            // Results table
            summary += `| Test | Status |\n`;
            summary += `|------|:------:|\n`;
            for (const [test, result] of Object.entries(results)) {
              summary += `| ${test} | ${getIcon(result)} |\n`;
            }
            
            summary += `\n## What This Tests\n\n`;
            summary += `- **NFS**: Creates PVC, waits for immediate binding, then deletes PVC directly\n`;
            summary += `- **NVMe-oF**: Creates PVC, uses temp pod for binding (WaitForFirstConsumer), deletes pod, then deletes PVC\n`;
            summary += `- **NVMe-oF (Nested Dataset)**: Same as NVMe-oF but with deeply nested parentDataset path (e.g., pool/democratic-csi/nvmefc/volumes)\n\n`;
            summary += `All tests verify that the TrueNAS backend resources (datasets/zvols, NFS shares, NVMe-oF subsystems) are properly cleaned up.\n`;
            
            // Write to job summary
            await core.summary.addRaw(summary).write();
            
            // Fail if any test failed
            if (failed > 0) {
              core.setFailed(`${failed} test(s) failed`);
            }

  # ==========================================
  # TrueNAS Cleanup (runs after all tests)
  # ==========================================
  truenas-cleanup:
    name: "TrueNAS Cleanup"
    runs-on: new
    timeout-minutes: 10
    needs: [test-summary]
    if: always()
    steps:
      - uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
      - name: Run TrueNAS Cleanup
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          echo "=== Running TrueNAS Cleanup ==="
          echo "This ensures no orphaned resources remain after test runs"
          echo ""
          ./scripts/cleanup-truenas-artifacts.sh
          echo ""
          echo "=== TrueNAS Cleanup Complete ==="
