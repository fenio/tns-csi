name: Kubernetes Distribution Permutation Testing

on:
  workflow_dispatch:

jobs:
  # Job for each matrix permutation - d1
  test-d1:
    name: Test ${{ matrix.order }} - Step 1
    runs-on: [self-hosted, Linux]
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          # All 24 permutations of 4 distributions
          - order: "KubeSolo → K3s → k0s → Minikube"
            distro: "kubesolo"
            id: "perm1"
          - order: "KubeSolo → K3s → Minikube → k0s"
            distro: "kubesolo"
            id: "perm2"
          - order: "KubeSolo → k0s → K3s → Minikube"
            distro: "kubesolo"
            id: "perm3"
          - order: "KubeSolo → k0s → Minikube → K3s"
            distro: "kubesolo"
            id: "perm4"
          - order: "KubeSolo → Minikube → K3s → k0s"
            distro: "kubesolo"
            id: "perm5"
          - order: "KubeSolo → Minikube → k0s → K3s"
            distro: "kubesolo"
            id: "perm6"
          - order: "K3s → KubeSolo → k0s → Minikube"
            distro: "k3s"
            id: "perm7"
          - order: "K3s → KubeSolo → Minikube → k0s"
            distro: "k3s"
            id: "perm8"
          - order: "K3s → k0s → KubeSolo → Minikube"
            distro: "k3s"
            id: "perm9"
          - order: "K3s → k0s → Minikube → KubeSolo"
            distro: "k3s"
            id: "perm10"
          - order: "K3s → Minikube → KubeSolo → k0s"
            distro: "k3s"
            id: "perm11"
          - order: "K3s → Minikube → k0s → KubeSolo"
            distro: "k3s"
            id: "perm12"
          - order: "k0s → KubeSolo → K3s → Minikube"
            distro: "k0s"
            id: "perm13"
          - order: "k0s → KubeSolo → Minikube → K3s"
            distro: "k0s"
            id: "perm14"
          - order: "k0s → K3s → KubeSolo → Minikube"
            distro: "k0s"
            id: "perm15"
          - order: "k0s → K3s → Minikube → KubeSolo"
            distro: "k0s"
            id: "perm16"
          - order: "k0s → Minikube → KubeSolo → K3s"
            distro: "k0s"
            id: "perm17"
          - order: "k0s → Minikube → K3s → KubeSolo"
            distro: "k0s"
            id: "perm18"
          - order: "Minikube → KubeSolo → K3s → k0s"
            distro: "minikube"
            id: "perm19"
          - order: "Minikube → KubeSolo → k0s → K3s"
            distro: "minikube"
            id: "perm20"
          - order: "Minikube → K3s → KubeSolo → k0s"
            distro: "minikube"
            id: "perm21"
          - order: "Minikube → K3s → k0s → KubeSolo"
            distro: "minikube"
            id: "perm22"
          - order: "Minikube → k0s → KubeSolo → K3s"
            distro: "minikube"
            id: "perm23"
          - order: "Minikube → k0s → K3s → KubeSolo"
            distro: "minikube"
            id: "perm24"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          rm kubectl

      - name: Setup KubeSolo
        if: ${{ matrix.distro == 'kubesolo' }}
        uses: fenio/setup-kubesolo@main
        with:
          timeout: 60
      
      - name: Setup K3s
        if: ${{ matrix.distro == 'k3s' }}
        uses: fenio/setup-k3s@main
        with:
          timeout: 60
      
      - name: Setup k0s
        if: ${{ matrix.distro == 'k0s' }}
        uses: fenio/setup-k0s@main
        with:
          timeout: 60
      
      - name: Setup Minikube
        if: ${{ matrix.distro == 'minikube' }}
        uses: fenio/setup-minikube@main
        with:
          timeout: 60
          driver: docker

      - name: Verify cluster
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A

      - name: Test workload
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  # Job for each matrix permutation - d2
  test-d2:
    name: Test ${{ matrix.order }} - Step 2
    runs-on: [self-hosted, Linux]
    needs: test-d1
    if: always()
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - order: "KubeSolo → K3s → k0s → Minikube"
            distro: "k3s"
            id: "perm1"
          - order: "KubeSolo → K3s → Minikube → k0s"
            distro: "k3s"
            id: "perm2"
          - order: "KubeSolo → k0s → K3s → Minikube"
            distro: "k0s"
            id: "perm3"
          - order: "KubeSolo → k0s → Minikube → K3s"
            distro: "k0s"
            id: "perm4"
          - order: "KubeSolo → Minikube → K3s → k0s"
            distro: "minikube"
            id: "perm5"
          - order: "KubeSolo → Minikube → k0s → K3s"
            distro: "minikube"
            id: "perm6"
          - order: "K3s → KubeSolo → k0s → Minikube"
            distro: "kubesolo"
            id: "perm7"
          - order: "K3s → KubeSolo → Minikube → k0s"
            distro: "kubesolo"
            id: "perm8"
          - order: "K3s → k0s → KubeSolo → Minikube"
            distro: "k0s"
            id: "perm9"
          - order: "K3s → k0s → Minikube → KubeSolo"
            distro: "k0s"
            id: "perm10"
          - order: "K3s → Minikube → KubeSolo → k0s"
            distro: "minikube"
            id: "perm11"
          - order: "K3s → Minikube → k0s → KubeSolo"
            distro: "minikube"
            id: "perm12"
          - order: "k0s → KubeSolo → K3s → Minikube"
            distro: "kubesolo"
            id: "perm13"
          - order: "k0s → KubeSolo → Minikube → K3s"
            distro: "kubesolo"
            id: "perm14"
          - order: "k0s → K3s → KubeSolo → Minikube"
            distro: "k3s"
            id: "perm15"
          - order: "k0s → K3s → Minikube → KubeSolo"
            distro: "k3s"
            id: "perm16"
          - order: "k0s → Minikube → KubeSolo → K3s"
            distro: "minikube"
            id: "perm17"
          - order: "k0s → Minikube → K3s → KubeSolo"
            distro: "minikube"
            id: "perm18"
          - order: "Minikube → KubeSolo → K3s → k0s"
            distro: "kubesolo"
            id: "perm19"
          - order: "Minikube → KubeSolo → k0s → K3s"
            distro: "kubesolo"
            id: "perm20"
          - order: "Minikube → K3s → KubeSolo → k0s"
            distro: "k3s"
            id: "perm21"
          - order: "Minikube → K3s → k0s → KubeSolo"
            distro: "k3s"
            id: "perm22"
          - order: "Minikube → k0s → KubeSolo → K3s"
            distro: "k0s"
            id: "perm23"
          - order: "Minikube → k0s → K3s → KubeSolo"
            distro: "k0s"
            id: "perm24"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          rm kubectl

      - name: Setup KubeSolo
        if: ${{ matrix.distro == 'kubesolo' }}
        uses: fenio/setup-kubesolo@main
        with:
          timeout: 60
      
      - name: Setup K3s
        if: ${{ matrix.distro == 'k3s' }}
        uses: fenio/setup-k3s@main
        with:
          timeout: 60
      
      - name: Setup k0s
        if: ${{ matrix.distro == 'k0s' }}
        uses: fenio/setup-k0s@main
        with:
          timeout: 60
      
      - name: Setup Minikube
        if: ${{ matrix.distro == 'minikube' }}
        uses: fenio/setup-minikube@main
        with:
          timeout: 60
          driver: docker

      - name: Verify cluster
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A

      - name: Test workload
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  # Job for each matrix permutation - d3
  test-d3:
    name: Test ${{ matrix.order }} - Step 3
    runs-on: [self-hosted, Linux]
    needs: test-d2
    if: always()
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - order: "KubeSolo → K3s → k0s → Minikube"
            distro: "k0s"
            id: "perm1"
          - order: "KubeSolo → K3s → Minikube → k0s"
            distro: "minikube"
            id: "perm2"
          - order: "KubeSolo → k0s → K3s → Minikube"
            distro: "k3s"
            id: "perm3"
          - order: "KubeSolo → k0s → Minikube → K3s"
            distro: "minikube"
            id: "perm4"
          - order: "KubeSolo → Minikube → K3s → k0s"
            distro: "k3s"
            id: "perm5"
          - order: "KubeSolo → Minikube → k0s → K3s"
            distro: "k0s"
            id: "perm6"
          - order: "K3s → KubeSolo → k0s → Minikube"
            distro: "k0s"
            id: "perm7"
          - order: "K3s → KubeSolo → Minikube → k0s"
            distro: "minikube"
            id: "perm8"
          - order: "K3s → k0s → KubeSolo → Minikube"
            distro: "kubesolo"
            id: "perm9"
          - order: "K3s → k0s → Minikube → KubeSolo"
            distro: "minikube"
            id: "perm10"
          - order: "K3s → Minikube → KubeSolo → k0s"
            distro: "kubesolo"
            id: "perm11"
          - order: "K3s → Minikube → k0s → KubeSolo"
            distro: "k0s"
            id: "perm12"
          - order: "k0s → KubeSolo → K3s → Minikube"
            distro: "k3s"
            id: "perm13"
          - order: "k0s → KubeSolo → Minikube → K3s"
            distro: "minikube"
            id: "perm14"
          - order: "k0s → K3s → KubeSolo → Minikube"
            distro: "kubesolo"
            id: "perm15"
          - order: "k0s → K3s → Minikube → KubeSolo"
            distro: "minikube"
            id: "perm16"
          - order: "k0s → Minikube → KubeSolo → K3s"
            distro: "kubesolo"
            id: "perm17"
          - order: "k0s → Minikube → K3s → KubeSolo"
            distro: "k3s"
            id: "perm18"
          - order: "Minikube → KubeSolo → K3s → k0s"
            distro: "k3s"
            id: "perm19"
          - order: "Minikube → KubeSolo → k0s → K3s"
            distro: "k0s"
            id: "perm20"
          - order: "Minikube → K3s → KubeSolo → k0s"
            distro: "kubesolo"
            id: "perm21"
          - order: "Minikube → K3s → k0s → KubeSolo"
            distro: "k0s"
            id: "perm22"
          - order: "Minikube → k0s → KubeSolo → K3s"
            distro: "kubesolo"
            id: "perm23"
          - order: "Minikube → k0s → K3s → KubeSolo"
            distro: "k3s"
            id: "perm24"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          rm kubectl

      - name: Setup KubeSolo
        if: ${{ matrix.distro == 'kubesolo' }}
        uses: fenio/setup-kubesolo@main
        with:
          timeout: 60
      
      - name: Setup K3s
        if: ${{ matrix.distro == 'k3s' }}
        uses: fenio/setup-k3s@main
        with:
          timeout: 60
      
      - name: Setup k0s
        if: ${{ matrix.distro == 'k0s' }}
        uses: fenio/setup-k0s@main
        with:
          timeout: 60
      
      - name: Setup Minikube
        if: ${{ matrix.distro == 'minikube' }}
        uses: fenio/setup-minikube@main
        with:
          timeout: 60
          driver: docker

      - name: Verify cluster
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A

      - name: Test workload
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  # Job for each matrix permutation - d4
  test-d4:
    name: Test ${{ matrix.order }} - Step 4
    runs-on: [self-hosted, Linux]
    needs: test-d3
    if: always()
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - order: "KubeSolo → K3s → k0s → Minikube"
            distro: "minikube"
            id: "perm1"
          - order: "KubeSolo → K3s → Minikube → k0s"
            distro: "k0s"
            id: "perm2"
          - order: "KubeSolo → k0s → K3s → Minikube"
            distro: "minikube"
            id: "perm3"
          - order: "KubeSolo → k0s → Minikube → K3s"
            distro: "k3s"
            id: "perm4"
          - order: "KubeSolo → Minikube → K3s → k0s"
            distro: "k0s"
            id: "perm5"
          - order: "KubeSolo → Minikube → k0s → K3s"
            distro: "k3s"
            id: "perm6"
          - order: "K3s → KubeSolo → k0s → Minikube"
            distro: "minikube"
            id: "perm7"
          - order: "K3s → KubeSolo → Minikube → k0s"
            distro: "k0s"
            id: "perm8"
          - order: "K3s → k0s → KubeSolo → Minikube"
            distro: "minikube"
            id: "perm9"
          - order: "K3s → k0s → Minikube → KubeSolo"
            distro: "kubesolo"
            id: "perm10"
          - order: "K3s → Minikube → KubeSolo → k0s"
            distro: "k0s"
            id: "perm11"
          - order: "K3s → Minikube → k0s → KubeSolo"
            distro: "kubesolo"
            id: "perm12"
          - order: "k0s → KubeSolo → K3s → Minikube"
            distro: "minikube"
            id: "perm13"
          - order: "k0s → KubeSolo → Minikube → K3s"
            distro: "k3s"
            id: "perm14"
          - order: "k0s → K3s → KubeSolo → Minikube"
            distro: "minikube"
            id: "perm15"
          - order: "k0s → K3s → Minikube → KubeSolo"
            distro: "kubesolo"
            id: "perm16"
          - order: "k0s → Minikube → KubeSolo → K3s"
            distro: "k3s"
            id: "perm17"
          - order: "k0s → Minikube → K3s → KubeSolo"
            distro: "kubesolo"
            id: "perm18"
          - order: "Minikube → KubeSolo → K3s → k0s"
            distro: "k0s"
            id: "perm19"
          - order: "Minikube → KubeSolo → k0s → K3s"
            distro: "k3s"
            id: "perm20"
          - order: "Minikube → K3s → KubeSolo → k0s"
            distro: "k0s"
            id: "perm21"
          - order: "Minikube → K3s → k0s → KubeSolo"
            distro: "kubesolo"
            id: "perm22"
          - order: "Minikube → k0s → KubeSolo → K3s"
            distro: "k3s"
            id: "perm23"
          - order: "Minikube → k0s → K3s → KubeSolo"
            distro: "kubesolo"
            id: "perm24"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          rm kubectl

      - name: Setup KubeSolo
        if: ${{ matrix.distro == 'kubesolo' }}
        uses: fenio/setup-kubesolo@main
        with:
          timeout: 60
      
      - name: Setup K3s
        if: ${{ matrix.distro == 'k3s' }}
        uses: fenio/setup-k3s@main
        with:
          timeout: 60
      
      - name: Setup k0s
        if: ${{ matrix.distro == 'k0s' }}
        uses: fenio/setup-k0s@main
        with:
          timeout: 60
      
      - name: Setup Minikube
        if: ${{ matrix.distro == 'minikube' }}
        uses: fenio/setup-minikube@main
        with:
          timeout: 60
          driver: docker

      - name: Verify cluster
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Checking cluster info..."
          kubectl cluster-info
          
          echo "Checking nodes..."
          kubectl get nodes -o wide
          
          echo "Checking system pods..."
          kubectl get pods -A

      - name: Test workload
        env:
          KUBECONFIG: ${{ matrix.distro == 'kubesolo' && '/var/lib/kubesolo/pki/admin/admin.kubeconfig' || '' }}
        run: |
          echo "Waiting for default service account..."
          for i in {1..60}; do
            if kubectl get serviceaccount default -n default &>/dev/null; then
              echo "Default service account is ready"
              break
            fi
            echo "Waiting for default service account... ($i/60)"
            sleep 1
          done
          
          echo "Creating test pod..."
          kubectl run test-pod --image=nginx:latest --restart=Never
          
          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          
          echo "Pod status:"
          kubectl get pod test-pod -o wide
          
          echo "Cleaning up..."
          kubectl delete pod test-pod

  summary:
    name: Permutation Test Summary
    runs-on: [self-hosted, Linux]
    needs: [test-d1, test-d2, test-d3, test-d4]
    if: always()
    steps:
      - name: Report results
        run: |
          echo "# Kubernetes Distribution Permutation Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested all 24 permutations of 4 distributions (KubeSolo, K3s, k0s, Minikube)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Step 1: ${{ needs.test-d1.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Step 2: ${{ needs.test-d2.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Step 3: ${{ needs.test-d3.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Step 4: ${{ needs.test-d4.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-d1.result }}" == "success" ] && \
             [ "${{ needs.test-d2.result }}" == "success" ] && \
             [ "${{ needs.test-d3.result }}" == "success" ] && \
             [ "${{ needs.test-d4.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All permutations passed! Cleanup works correctly between all distribution combinations." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Some permutations failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
          fi
