name: Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  integration-nfs:
    name: NFS Integration Tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nfs-common
      
      - name: Install Docker
        run: |
          if ! command -v docker &> /dev/null; then
            echo "Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            rm get-docker.sh
          else
            echo "Docker already installed"
          fi
          sudo usermod -aG docker $USER
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Install k3s
        run: |
          if ! command -v k3s &> /dev/null; then
            echo "Installing k3s..."
            curl -sfL https://get.k3s.io | sh -s - \
              --write-kubeconfig-mode 644 \
              --disable traefik \
              --disable servicelb
          else
            echo "k3s already installed"
          fi
          sudo k3s kubectl wait --for=condition=Ready node --all --timeout=60s
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
          kubectl get nodes
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Clean up previous deployment
        run: |
          # Step 1: Uninstall driver first (stops CSI controllers/nodes from reconciling)
          helm uninstall tns-csi --namespace kube-system --wait --timeout 2m || true
          
          # Step 2: Force delete all driver pods immediately
          kubectl delete pods -n kube-system -l app.kubernetes.io/name=tns-csi-driver --force --grace-period=0 --ignore-not-found=true || true
          
          # Step 3: Wait for driver pods to be completely gone
          kubectl wait --for=delete pod -n kube-system -l app.kubernetes.io/name=tns-csi-driver --timeout=30s 2>/dev/null || true
          
          # Step 4: Clean up test namespaces (this removes PVCs in those namespaces)
          kubectl delete namespace -l test-csi=true --force --grace-period=0 --ignore-not-found=true || true
          
          # Step 5: Force delete any remaining PVCs across all namespaces
          kubectl delete pvc --all --all-namespaces --force --grace-period=0 --ignore-not-found=true || true
          
          # Step 6: Patch any PVs to remove finalizers, then force delete
          for pv in $(kubectl get pv -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo ""); do
            if [[ -n "$pv" ]]; then
              kubectl patch pv "$pv" -p '{"metadata":{"finalizers":[]}}' --type=merge 2>/dev/null || true
              kubectl delete pv "$pv" --force --grace-period=0 --ignore-not-found=true || true
            fi
          done
          
          # Step 7: Delete storage classes
          kubectl delete storageclass tns-csi-nfs tns-nvmeof tns-iscsi --ignore-not-found=true || true
          
          # Step 8: Verify cleanup completed
          echo "=== Remaining PVCs ==="
          kubectl get pvc --all-namespaces 2>/dev/null || echo "No PVCs remaining"
          echo "=== Remaining PVs ==="
          kubectl get pv 2>/dev/null || echo "No PVs remaining"
          
          # Step 9: Wait for resources to be fully cleaned up
          sleep 15
      
      - name: Run NFS Integration Test
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-nfs.sh

  integration-nvmeof:
    name: NVMe-oF Integration Tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget git make nvme-cli
          sudo modprobe nvme-tcp || echo "nvme-tcp module already loaded"
      
      - name: Install Docker
        run: |
          if ! command -v docker &> /dev/null; then
            echo "Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            rm get-docker.sh
          else
            echo "Docker already installed"
          fi
          sudo usermod -aG docker $USER
      
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.3'
          cache: false
      
      - name: Install Helm
        run: |
          if ! command -v helm &> /dev/null; then
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "Helm already installed"
          fi
      
      - name: Install k3s
        run: |
          if ! command -v k3s &> /dev/null; then
            echo "Installing k3s..."
            curl -sfL https://get.k3s.io | sh -
          else
            echo "k3s already installed"
          fi
          sudo k3s kubectl wait --for=condition=Ready node --all --timeout=60s
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER:$USER ~/.kube/config
          kubectl get nodes
      
      - name: Build CSI driver image
        run: |
          sudo -E make docker-build
          sudo docker save bfenski/tns-csi:latest | sudo k3s ctr images import -
      
      - name: Clean up previous deployment
        run: |
          # Step 1: Uninstall driver first (stops CSI controllers/nodes from reconciling)
          helm uninstall tns-csi --namespace kube-system --wait --timeout 2m || true
          
          # Step 2: Force delete all driver pods immediately
          kubectl delete pods -n kube-system -l app.kubernetes.io/name=tns-csi-driver --force --grace-period=0 --ignore-not-found=true || true
          
          # Step 3: Wait for driver pods to be completely gone
          kubectl wait --for=delete pod -n kube-system -l app.kubernetes.io/name=tns-csi-driver --timeout=30s 2>/dev/null || true
          
          # Step 4: Clean up test namespaces (this removes PVCs in those namespaces)
          kubectl delete namespace -l test-csi=true --force --grace-period=0 --ignore-not-found=true || true
          
          # Step 5: Force delete any remaining PVCs across all namespaces
          kubectl delete pvc --all --all-namespaces --force --grace-period=0 --ignore-not-found=true || true
          
          # Step 6: Patch any PVs to remove finalizers, then force delete
          for pv in $(kubectl get pv -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo ""); do
            if [[ -n "$pv" ]]; then
              kubectl patch pv "$pv" -p '{"metadata":{"finalizers":[]}}' --type=merge 2>/dev/null || true
              kubectl delete pv "$pv" --force --grace-period=0 --ignore-not-found=true || true
            fi
          done
          
          # Step 7: Delete storage classes
          kubectl delete storageclass tns-csi-nfs tns-nvmeof tns-iscsi --ignore-not-found=true || true
          
          # Step 8: Verify cleanup completed
          echo "=== Remaining PVCs ==="
          kubectl get pvc --all-namespaces 2>/dev/null || echo "No PVCs remaining"
          echo "=== Remaining PVs ==="
          kubectl get pv 2>/dev/null || echo "No PVs remaining"
          
          # Step 9: Wait for resources to be fully cleaned up
          sleep 15
      
      - name: Run NVMe-oF Integration Test (Filesystem)
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-nvmeof.sh
      
      - name: Run NVMe-oF Integration Test (Block)
        env:
          TRUENAS_HOST: ${{ secrets.TRUENAS_HOST }}
          TRUENAS_API_KEY: ${{ secrets.TRUENAS_API_KEY }}
          TRUENAS_POOL: ${{ secrets.TRUENAS_POOL }}
        run: |
          ./tests/integration/test-nvmeof-block.sh
