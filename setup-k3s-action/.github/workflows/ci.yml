name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain dist/)" ]; then
            echo "ERROR: dist/ has uncommitted changes after build"
            echo "Please run 'npm run build' and commit the changes"
            git status --porcelain dist/
            exit 1
          fi

  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Test action
        id: k3s
        uses: ./
        with:
          version: stable
          wait-for-ready: true
          timeout: 120
      
      - name: Verify cluster
        env:
          KUBECONFIG: ${{ steps.k3s.outputs.kubeconfig }}
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          
          echo "=== Nodes ==="
          kubectl get nodes -o wide
          
          echo "=== System Pods ==="
          kubectl get pods -n kube-system
          
          echo "=== Deploy test pod ==="
          kubectl run test-pod --image=nginx:alpine --restart=Never
          kubectl wait --for=condition=Ready pod/test-pod --timeout=60s
          kubectl delete pod test-pod
          
          echo "âœ“ All tests passed!"
