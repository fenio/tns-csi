name: Setup Fresh minikube Cluster
description: Destroy existing minikube cluster and create a fresh one for testing

runs:
  using: composite
  steps:
    - name: Destroy all existing Kubernetes clusters
      shell: bash
      run: |
        echo "=== Destroying ALL existing Kubernetes clusters for clean state ==="
        
        # Stop k3s if running
        if command -v k3s-uninstall.sh &> /dev/null; then
          echo "Uninstalling k3s..."
          sudo k3s-uninstall.sh || true
        fi
        sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s || true
        
        # Stop k0s if running
        if command -v k0s &> /dev/null; then
          echo "Stopping k0s..."
          sudo k0s stop || true
          sudo k0s reset || true
        fi
        sudo systemctl stop k0scontroller.service || true
        sudo systemctl stop k0sworker.service || true
        sudo systemctl disable k0scontroller.service || true
        sudo systemctl disable k0sworker.service || true
        sudo rm -rf /etc/k0s /var/lib/k0s || true
        
        # Clean up containerd sockets and directories from k3s and k0s
        # Note: With containerd 2.x upgrade, shim version compatibility is now resolved
        echo "Cleaning up k3s and k0s containerd state..."
        sudo rm -rf /run/k0s/containerd.sock || true
        sudo rm -rf /var/lib/k0s/containerd || true
        sudo rm -rf /run/k3s/containerd/containerd.sock || true
        sudo rm -rf /var/lib/rancher/k3s/agent/containerd || true
        
        # Stop minikube if running
        if command -v minikube &> /dev/null; then
          echo "Stopping minikube..."
          minikube delete --all --purge || true
        fi
        sudo rm -rf ~/.minikube || true
        
        # Clean up kubeconfig
        sudo rm -rf ~/.kube/config || true
        
        # Wait for port 6443 to be free
        echo "Waiting for port 6443 to be free..."
        for i in {1..30}; do
          if ! sudo lsof -i :6443 &>/dev/null; then
            echo "Port 6443 is free"
            break
          fi
          echo "Port 6443 still in use, waiting... (attempt $i/30)"
          sleep 2
        done
        
        # Kill any remaining processes on port 6443
        sudo lsof -ti :6443 | xargs -r sudo kill -9 || true
        sleep 2
        
        echo "All clusters destroyed"

    - name: Install/Update minikube
      shell: bash
      run: |
        echo "=== Ensuring minikube is installed ==="
        if ! command -v minikube &> /dev/null; then
          echo "Installing minikube..."
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube
          rm minikube-linux-amd64
        else
          echo "minikube already installed: $(minikube version)"
        fi

    - name: Start minikube cluster
      shell: bash
      run: |
        echo "=== Starting fresh minikube cluster ==="
        
        # Start minikube with Docker driver (most compatible with self-hosted runners)
        # Use none driver if running as root, otherwise use docker
        if [[ $EUID -eq 0 ]]; then
          DRIVER="none"
        else
          DRIVER="docker"
        fi
        
        echo "Using driver: ${DRIVER}"
        
        minikube start \
          --driver="${DRIVER}" \
          --container-runtime=containerd \
          --wait=all \
          --wait-timeout=5m
        
        echo "=== Cluster nodes ==="
        kubectl get nodes
        echo "=== Cluster version ==="
        kubectl version

    - name: Import CSI driver image to minikube
      shell: bash
      run: |
        echo "=== Importing CSI driver image to minikube ==="
        
        # Method 1: Try minikube image load (works with Docker driver)
        if minikube image load bfenski/tns-csi:latest 2>&1 | tee /tmp/minikube-load.log; then
          echo "Image loaded via 'minikube image load'"
        else
          echo "WARNING: 'minikube image load' failed, trying alternative method..."
          cat /tmp/minikube-load.log || true
          
          # Method 2: Save from Docker and import to containerd
          echo "Saving image from Docker and importing to minikube's containerd..."
          sudo docker save bfenski/tns-csi:latest | minikube ssh -- sudo ctr -n k8s.io images import -
        fi
        
        # Verify image is available in minikube
        echo "=== Verifying image in minikube ==="
        minikube ssh -- sudo crictl images | grep -E "(REPOSITORY|tns-csi)" || {
          echo "ERROR: Image verification failed"
          echo "All images in minikube:"
          minikube ssh -- sudo crictl images
          exit 1
        }
